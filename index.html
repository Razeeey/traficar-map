<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>TrafiCar — Live</title>

<link rel="stylesheet" href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css"/>
<script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap">

<style>
  :root{
    --panel:#17171c; --panel2:#1f1f26; --text:#f5f6fa; --muted:#a7a7b4;
    --radius:12px; --shadow:0 10px 30px rgba(0,0,0,.35);
    --ink:#1a1b1e; --ink2:#6b7280; --card:#ffffff; --divider:#e5e7eb;
  }
  *{box-sizing:border-box}
  body{margin:0;background:#0c0c10;color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  #map{position:fixed;inset:0}

  .maplibregl-canvas{cursor:default !important;-webkit-tap-highlight-color:transparent}
  .maplibregl-canvas.dragging{cursor:grabbing !important}

  .topbar{
    position:fixed;left:12px;right:12px;top:12px;z-index:10;
    display:flex;align-items:center;gap:10px;flex-wrap:wrap;
    background:rgba(23,23,28,.82);backdrop-filter:saturate(1.2) blur(8px);
    border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);
    padding:8px 10px;box-shadow:var(--shadow)
  }
  .pill,.chip,.count{
    height:40px;border-radius:12px;display:inline-flex;align-items:center;gap:10px;
    padding:0 12px;border:1px solid rgba(255,255,255,.08);background:var(--panel2);
    color:var(--text);font-weight:600
  }
  .pill:hover,.chip:hover{border-color:rgba(255,255,255,.18)}
  .pill button{border:0;background:transparent;color:inherit;font:inherit;cursor:pointer}
  .chip{min-width:44px;justify-content:center;cursor:pointer}
  .chip svg{display:block}
  .count{border-radius:10px;cursor:default;user-select:none}
  .spacer{flex:1}

  .selectwrap{position:relative;display:flex;align-items:center}
  .selectwrap img{
    position:absolute;left:12px;top:50%;transform:translateY(-50%);
    width:24px;height:24px;opacity:.95;pointer-events:none
  }
  .selectwrap select{
    appearance:auto;-webkit-appearance:menulist;
    padding:8px 28px 8px 52px;
    height:40px;border-radius:12px;border:0;background:transparent;color:var(--text);
    cursor:pointer;outline:none;box-shadow:none;width:auto;min-width:120px;max-width:220px
  }
  .selectwrap select:focus{outline:none;box-shadow:none}
  .selectwrap select:focus-visible{outline:0}
  .selectwrap select option{color:#111;background:#fff}

  .panel{
    position:fixed;right:12px;top:64px;z-index:11;background:rgba(23,23,28,.92);
    backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.08);border-radius:12px;
    padding:12px;width:260px;box-shadow:var(--shadow);max-height:72vh;overflow:auto
  }
  .panel.hidden{display:none}
  .hdr{display:flex;align-items:center;justify-content:space-between;margin:4px 0 6px}
  .hdr h4{margin:0;font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.04em}
  .closebtn{width:28px;height:28px;border-radius:8px;border:1px solid rgba(255,255,255,.12);background:transparent;color:#e8e9f1;display:flex;align-items:center;justify-content:center;font-size:18px;line-height:1;cursor:pointer}
  .row{display:flex;align-items:center;gap:10px;margin:6px 0;font-size:14px}
  .panel input[type="checkbox"]{width:18px;height:18px;cursor:pointer;accent-color:#7b4bff}
  .panel .small{display:flex;gap:12px;margin:4px 0 2px}
  .panel .small a{font-size:12px;color:#bfc0ca;text-decoration:underline;cursor:pointer}

  @media (max-width:700px){
    .pill,.chip,.count{height:36px;border-radius:10px;padding:0 10px;font-size:14px}
    .selectwrap img{left:10px;width:24px;height:24px}
    .selectwrap select{height:36px;padding:6px 24px 6px 48px;min-width:120px;max-width:200px}
    .count{order:3;margin-left:auto}
    #filterBtn{order:4}
  }

  .maplibregl-popup{max-width:360px !important}
  .maplibregl-popup-content{padding:12px;border-radius:14px;background:var(--card);color:var(--ink);box-shadow:0 18px 50px rgba(0,0,0,.45);border:1px solid #eceff3}
  .maplibregl-popup-close-button{color:#444}
  .badge{background:#7b4bff;color:#fff;padding:4px 10px;border-radius:10px;font-weight:800;display:inline-block;min-width:52px;text-align:center}
  .muted{color:var(--ink2)}
  .infocard{min-width:300px;max-width:340px}
  .carimg{width:100%;height:auto;max-height:150px;object-fit:contain;border-radius:10px;background:transparent;margin-bottom:8px;display:block}
  .title{font-weight:800;font-size:16px;color:var(--ink)}
  .divider{height:1px;background:var(--divider);margin:6px 0 8px}

  .spinner{display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,.35);border-top-color:#fff;border-radius:50%;animation:spin .9s linear infinite;vertical-align:-2px;margin-left:8px}
  @keyframes spin{to{transform:rotate(360deg)}}
  button[disabled]{opacity:.6;cursor:not-allowed}

  .hoverTag{
    position:absolute;z-index:12;pointer-events:none;transform:translate(-50%,-140%);
    background:rgba(23,23,28,.92);border:1px solid rgba(255,255,255,.1);
    color:#fff;padding:4px 8px;border-radius:8px;font-size:12px;white-space:nowrap;
  }
</style>
</head>
<body>
<div id="map"></div>

<div class="topbar">
  <div class="pill selectwrap">
    <img src="/img/location-icon.png" alt="" />
    <select id="city">
      <option value="krakow">Kraków</option>
      <option value="warszawa">Warszawa</option>
      <option value="wroclaw">Wrocław</option>
      <option value="poznan">Poznań</option>
      <option value="trojmiasto">Trójmiasto</option>
      <option value="slask">Śląsk</option>
      <option value="lublin">Lublin</option>
      <option value="lodz">Łódź</option>
      <option value="szczecin">Szczecin</option>
      <option value="rzeszow">Rzeszów</option>
    </select>
  </div>
  <div class="pill"><button id="refresh">Refresh <span id="spin" class="spinner" style="display:none"></span></button></div>
  <div class="spacer"></div>
  <div id="count" class="count">0 cars</div>
  <button id="filterBtn" class="chip" aria-controls="filtersPanel" aria-expanded="false" title="Filtry">
    <svg viewBox="0 0 24 24" width="22" height="22" fill="none" aria-hidden="true">
      <path d="M12 3 3 7l9 4 9-4-9-4Z" stroke="currentColor" stroke-opacity=".85" stroke-width="1.7" />
      <path d="m3 12 9 4 9-4" stroke="currentColor" stroke-opacity=".85" stroke-width="1.7"/>
      <path d="m3 17 9 4 9-4" stroke="currentColor" stroke-opacity=".85" stroke-width="1.7"/>
    </svg>
  </button>
</div>

<div id="filtersPanel" class="panel hidden">
  <div class="hdr">
    <h4>OSOBOWE</h4>
    <button id="closeFilters" class="closebtn" aria-label="Zamknij">×</button>
  </div>
  <div id="models-cars"></div>

  <div class="hdr" style="margin-top:10px"><h4>DOSTAWCZE</h4></div>
  <div id="models-vans"></div>

  <div class="hdr" style="margin-top:10px"><h4>MIKROMOBILNOŚĆ</h4></div>
  <div id="models-scooters"></div>

  <div class="small"><a id="all">Zaznacz wszystko</a><a id="none">Wyczyść</a></div>
  <hr style="border:none;border-top:1px solid rgba(255,255,255,.08);margin:10px 0">

  <div class="hdr"><h4>STREFY</h4></div>
  <div class="row"><input type="checkbox" id="toggle-rel" checked><label for="toggle-rel">Relokacja</label></div>
  <div class="row"><input type="checkbox" id="toggle-nop" checked><label for="toggle-nop">Zakaz parkowania</label></div>
  <div class="row"><input type="checkbox" id="toggle-og" checked><label for="toggle-og">Ogarniam</label></div>
</div>

<div id="hoverTag" class="hoverTag" style="display:none"></div>

<script>
(function(){
  const MAPTILER_KEY = 'om295piVB9WpF6hwX1iC';
  const API_CARS  = '/.netlify/functions/traficar-auto';
  const API_AREAS = '/.netlify/functions/traficar-areas';

  const centers = {
    krakow:{lng:19.9383,lat:50.0614,z:13}, warszawa:{lng:21.0122,lat:52.2297,z:12},
    wroclaw:{lng:17.0385,lat:51.1079,z:13}, poznan:{lng:16.9252,lat:52.4064,z:13},
    trojmiasto:{lng:18.6383,lat:54.3722,z:11}, slask:{lng:19.0238,lat:50.2649,z:11},
    lublin:{lng:22.5684,lat:51.2465,z:13}, lodz:{lng:19.4550,lat:51.7592,z:12},
    szczecin:{lng:14.5528,lat:53.4285,z:12}, rzeszow:{lng:21.9990,lat:50.0413,z:13}
  };
  const params = new URLSearchParams(location.search);
  const initialCity = centers[params.get('city')] ? params.get('city') : 'krakow';

  var citySel   = document.getElementById('city');
  var refreshBtn= document.getElementById('refresh');
  var spinEl    = document.getElementById('spin');
  var countEl   = document.getElementById('count');
  var filterBtn = document.getElementById('filterBtn');
  var panelEl   = document.getElementById('filtersPanel');
  var closeBtn  = document.getElementById('closeFilters');
  var hoverTag  = document.getElementById('hoverTag');

  var allBtn = document.getElementById('all');
  var noneBtn= document.getElementById('none');
  var relCB  = document.getElementById('toggle-rel');
  var nopCB  = document.getElementById('toggle-nop');
  var ogCB   = document.getElementById('toggle-og');

  function setRefreshing(on){ refreshBtn.disabled = !!on; spinEl.style.display = on?'inline-block':'none'; }

  function openFilters(){ panelEl.classList.remove('hidden'); filterBtn.setAttribute('aria-expanded','true'); }
  function closeFilters(){ panelEl.classList.add('hidden');  filterBtn.setAttribute('aria-expanded','false'); }
  filterBtn.addEventListener('click', function(){ panelEl.classList.contains('hidden') ? openFilters() : closeFilters(); });
  closeBtn.addEventListener('click', closeFilters);

  var clickingMap = false;
  document.addEventListener('pointerdown', function(e){
    var mapEl = document.querySelector('.maplibregl-canvas');
    if (e.target === mapEl && !panelEl.classList.contains('hidden')) clickingMap = true;
  });
  document.addEventListener('pointerup', function(){
    if (clickingMap){ clickingMap = false; closeFilters(); }
  });

  citySel.value = initialCity;
  var currentCity = citySel.value;

  function fitCityWidth(){
    var text = citySel.options[citySel.selectedIndex].text || '';
    var probe = document.createElement('span');
    var cs = getComputedStyle(citySel);
    probe.style.cssText = 'position:absolute;visibility:hidden;white-space:pre;font:'+cs.fontSize+' '+cs.fontFamily+';font-weight:'+cs.fontWeight;
    probe.textContent = text;
    document.body.appendChild(probe);
    var w = probe.getBoundingClientRect().width;
    document.body.removeChild(probe);
    var pad = 52 + 28;
    var min = 120, max = (window.matchMedia && matchMedia('(max-width:700px)').matches) ? 200 : 220;
    citySel.style.width = Math.min(max, Math.max(min, Math.ceil(w + pad))) + 'px';
  }

  var modelSelections = new Map();
  var modelOptions    = new Map();
  var lastUIChange = 0;

  function slug(s){ return String(s||'').toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9\-]/g,''); }
  var CUSTOM_FILE_BY_MODEL = {
    'renault-arkana':  'renault-arkana-traficar',
    'renault-clio-v':  'renault-clio-traficar',
    'dacia-sandero':   'dacia-sandero-traficar',
    'dacia-dokker':    'dacia-dokker-traficar',
    'renault-express': 'renault-express-traficar',
    'renault-master':  'renault-master-traficar',
    'navee-d1-pro':    'NAVEE-D1-PRO-traficar'
  };
  function modelImage(model){
    var s = slug(model);
    var base = CUSTOM_FILE_BY_MODEL[s] ? '/img/'+CUSTOM_FILE_BY_MODEL[s] : '/img/'+s;
    return { webp: base + '.webp', jpg: base + '.jpg' };
  }

  function loadPng(url){
    return new Promise(function(resolve, reject){
      var img = new Image(); img.decoding='async';
      img.onload = function(){ resolve(img); }; img.onerror = reject; img.src=url;
    });
  }

  function pinImageData(kind, iconImg){
    var color = kind==='van' ? '#1d4ed8' : (kind==='scooter' ? '#2dd4bf' : '#7b4bff');
    var size=64, r=16, cx=size/2, cy=size/2-2;
    var cvs=document.createElement('canvas'); cvs.width=size; cvs.height=size;
    var g=cvs.getContext('2d');

    g.beginPath(); g.ellipse(cx, cy + r + 10, r*0.9, r*0.45, 0, 0, Math.PI*2); g.fillStyle='rgba(0,0,0,.45)'; g.fill();
    g.beginPath(); g.arc(cx, cy, r, 0, Math.PI*2); g.fillStyle=color; g.fill();
    g.beginPath(); g.moveTo(cx, cy + r); g.lineTo(cx + 7, cy + r + 14); g.lineTo(cx - 7, cy + r + 14); g.closePath(); g.fillStyle=color; g.fill();
    g.lineWidth=2; g.strokeStyle='#1a1a1a';
    g.beginPath(); g.arc(cx, cy, r, 0, Math.PI*2); g.stroke();
    g.beginPath(); g.moveTo(cx, cy + r); g.lineTo(cx + 7, cy + r + 14); g.lineTo(cx - 7, cy + r + 14); g.closePath(); g.stroke();
    if(iconImg){
      var ICON = (kind==='car') ? 28 : 22;
      g.drawImage(iconImg, cx-ICON/2, cy-ICON/2, ICON, ICON);
    }
    return g.getImageData(0,0,size,size);
  }

  function pieImageData(c,v,s){
    var size=64*2,r=size/2,cvs=document.createElement('canvas');cvs.width=size;cvs.height=size;var g=cvs.getContext('2d');
    g.beginPath();g.arc(r,r,r-4,0,Math.PI*2);g.fillStyle='#3e3e45';g.fill();
    var T=Math.max(1,c+v+s);var a=-Math.PI/2;
    function slice(n,col){var ang=(n/T)*Math.PI*2;g.beginPath();g.moveTo(r,r);g.arc(r,r,r-8,a,a+ang,false);g.closePath();g.fillStyle=col;g.fill();a+=ang;}
    slice(c,'#7b4bff'); slice(v,'#1d4ed8'); slice(s,'#2dd4bf');
    g.beginPath();g.arc(r,r,r-28,0,Math.PI*2);g.fillStyle='#121218';g.fill();
    g.beginPath();g.arc(r,r,r-3,0,Math.PI*2);g.strokeStyle='#111';g.lineWidth=4;g.stroke();
    return g.getImageData(0,0,size,size);
  }

  var map = new maplibregl.Map({
    container:'map',
    style:'https://api.maptiler.com/maps/dataviz-dark/style.json?key='+MAPTILER_KEY,
    center: centers[initialCity],
    zoom: centers[initialCity].z,
    attributionControl:true
  });
  map.addControl(new maplibregl.NavigationControl({ showCompass:false }), 'bottom-right');

  map.on('dragstart', function(){ var c=document.querySelector('.maplibregl-canvas'); if(c) c.classList.add('dragging'); });
  map.on('dragend',   function(){ var c=document.querySelector('.maplibregl-canvas'); if(c) c.classList.remove('dragging'); });

  map.on('click', function(e){
    var feats = map.queryRenderedFeatures(e.point, { layers:['cars-pin'] });
    if (feats && feats.length){
      var f=feats[0]; var v=f.properties; var coords=f.geometry.coordinates;
      var lng=coords[0], lat=coords[1];
      var badge=v.number?(v.number):(v.id?String(v.id).slice(-4):''); var plate=v.plate||'';
      var pct=(v.pct!=null)?(v.pct+'%'):'—'; var range=(v.rangeKm!=null)?(' ('+v.rangeKm+' km)'):'';
      var addr=v.address||''; var apple='https://maps.apple.com/?ll='+lat+','+lng+'&q='+encodeURIComponent(v.model||'Car');
      var img=modelImage(v.model);
      var titleEsc = String(v.model||'Vehicle').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
      var html=
        '<div class="infocard">'+
          '<img class="carimg" loading="lazy" src="'+img.webp+'" '+
          'onerror="if(this.dataset.step!==\'jpg\'){this.dataset.step=\'jpg\';this.src=\''+img.jpg+'\';}else{this.onerror=null;this.style.display=\'none\';}" '+
          'alt="'+titleEsc+'">'+
          '<div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">'+
            '<span class="badge">'+badge+'</span>'+
            '<div class="title">'+titleEsc+'</div>'+
          '</div>'+
          '<div class="muted" style="margin:-2px 0 8px">'+(plate||'&nbsp;')+'</div>'+
          '<div class="muted" style="margin:6px 0">⛽ <b>'+pct+range+'</b></div>'+
          '<div class="muted" style="margin:6px 0">📍 '+addr+'</div>'+
          '<div class="divider"></div>'+
          '<div style="margin:8px 0"><a href="'+apple+'" target="_blank" rel="noopener">Open in Apple Maps</a></div>'+
        '</div>';
      new maplibregl.Popup({closeButton:true,offset:12}).setLngLat([lng,lat]).setHTML(html).addTo(map);
    }else{
      if(!panelEl.classList.contains('hidden')) closeFilters();
    }
  });

  map.on('load', function(){
    Promise.all([loadPng('/img/car-icon.png'),loadPng('/img/truck-icon.png'),loadPng('/img/scooter-icon.png')]).then(function(imgs){
      try { map.addImage('pin-car',     pinImageData('car',     imgs[0]), { pixelRatio:2 }); } catch(e){}
      try { map.addImage('pin-van',     pinImageData('van',     imgs[1]), { pixelRatio:2 }); } catch(e){}
      try { map.addImage('pin-scooter', pinImageData('scooter', imgs[2]), { pixelRatio:2 }); } catch(e){}
    });

    map.addSource('cars', {
      type:'geojson', data: emptyFC(),
      cluster:true, clusterRadius:64, clusterMaxZoom:14,
      clusterProperties:{
        car:["+",["case",["==",["get","kind"],"car"],1,0]],
        van:["+",["case",["==",["get","kind"],"van"],1,0]],
        scooter:["+",["case",["==",["get","kind"],"scooter"],1,0]]
      }
    });

    var PIE_CACHE = {};
    map.on('styleimagemissing', function(e){
      var m=/^pie_(\d+)_(\d+)_(\d+)$/.exec(e.id); if(!m||PIE_CACHE[e.id]) return;
      try{ map.addImage(e.id, pieImageData(+m[1],+m[2],+m[3]), { pixelRatio:2 }); PIE_CACHE[e.id]=1; map.triggerRepaint(); }catch(err){}
    });
    map.on('idle', function(){
      var feats=map.queryRenderedFeatures({layers:['clusters-pie']});
      for(var i=0;i<feats.length;i++){
        var f=feats[i];
        var id='pie_'+((f.properties.car|0))+'_'+((f.properties.van|0))+'_'+((f.properties.scooter|0));
        if(!map.hasImage(id)){ try{ map.addImage(id, pieImageData(f.properties.car|0,f.properties.van|0,f.properties.scooter|0), { pixelRatio:2 }); }catch(err){} }
      }
    });

    map.addLayer({ id:'clusters-bg', type:'circle', source:'cars', filter:['has','point_count'],
      paint:{'circle-color':'#3e3e45','circle-stroke-color':'#111','circle-stroke-width':2,
             'circle-radius':['interpolate',['linear'],['get','point_count'],2,14,50,18,200,24,500,28]}});
    map.addLayer({ id:'clusters-pie', type:'symbol', source:'cars', filter:['has','point_count'],
      layout:{'icon-image':['concat','pie_',['to-string',['coalesce',['get','car'],0]],'_',['to-string',['coalesce',['get','van'],0]],'_',['to-string',['coalesce',['get','scooter'],0]]],
              'icon-size':['interpolate',['linear'],['get','point_count'],2,.85,50,1.0,200,1.25,500,1.5],
              'icon-allow-overlap': true,
              'text-field':['get','point_count_abbreviated'],'text-size':12,
              'text-font':['Open Sans Semibold','Arial Unicode MS Bold'],'text-offset':[0,0],'text-allow-overlap':true},
      paint:{'text-color':'#ffffff','text-halo-color':'#111','text-halo-width':1.2}});

    map.addLayer({
      id: 'cars-pin',
      type: 'symbol',
      source: 'cars',
      filter: ['!',['has','point_count']],
      layout: {
        'icon-image': ['match', ['get','kind'],
          'van',     'pin-van',
          'scooter', 'pin-scooter',
          'pin-car'
        ],
        'icon-size': ['interpolate',['linear'],['zoom'],10,0.9,12,1.2,14,1.6,16,2.0,18,2.4],
        'icon-allow-overlap': true
      }
    });

    map.addSource('zones-relocation',{type:'geojson',data:emptyFC()});
    map.addSource('zones-nopark',{type:'geojson',data:emptyFC()});
    map.addSource('zones-ogarniam',{type:'geojson',data:emptyFC()});
    map.addLayer({id:'relocation-fill',type:'fill',source:'zones-relocation',paint:{'fill-color':'#ffd500','fill-opacity':0.22}});
    map.addLayer({id:'relocation-outline',type:'line',source:'zones-relocation',paint:{'line-color':'#ffd500','line-width':2}});
    map.addLayer({id:'nopark-fill',type:'fill',source:'zones-nopark',paint:{'fill-color':'#ff4d4d','fill-opacity':0.28}});
    map.addLayer({id:'nopark-outline',type:'line',source:'zones-nopark',paint:{'line-color':'#ff4d4d','line-width':1.5,'line-dasharray':[2,2]}});
    map.addLayer({id:'ogarniam-fill',type:'fill',source:'zones-ogarniam',paint:{'fill-color':'#a56cff','fill-opacity':0.16}});
    map.addLayer({id:'ogarniam-outline',type:'line',source:'zones-ogarniam',paint:{'line-color':'#a56cff','line-width':2}});

    function updateHover(e){
      var feats = map.queryRenderedFeatures(e.point, { layers:['cars-pin'] });
      var canvas = map.getCanvas();
      if (feats && feats.length){
        canvas.style.cursor = 'pointer';
        if (!('ontouchstart' in window)){
          var v=feats[0].properties;
          var fleet = v.number ? v.number : (v.id?String(v.id).slice(-4):'');
          hoverTag.textContent = (v.model||'Vehicle')+' • '+fleet;
          hoverTag.style.left = e.point.x+'px';
          hoverTag.style.top  = e.point.y+'px';
          hoverTag.style.display = 'block';
        }
      }else{
        canvas.style.cursor = 'default';
        hoverTag.style.display = 'none';
      }
    }
    map.on('mousemove', updateHover);
    map.on('mouseout', function(){ hoverTag.style.display='none'; map.getCanvas().style.cursor='default'; });

    loadAll(true,{fit:true});
    fitCityWidth();
  });

  var timer=null; window.__CITY_CACHE={cars:[]};
  function setCount(n){ countEl.textContent = n+' '+(n===1?'car':'cars'); }
  function emptyFC(){ return {type:'FeatureCollection',features:[]}; }
  function toGeo(data){
    return {
      type:'FeatureCollection',
      features:data.map(function(v){
        return {
          type:'Feature',
          geometry:{type:'Point',coordinates:[Number(v.lng),Number(v.lat)]},
          properties:{
            id:(v.id!=null?v.id:null),
            model:(v.model!=null?v.model:'Vehicle'),
            plate:(v.plate!=null?v.plate:''),
            number:(v.number!=null?v.number:''),
            pct:(typeof v.pct==='number')?v.pct:null,
            rangeKm:(typeof v.rangeKm==='number')?v.rangeKm:null,
            address:(v.address?v.address:''),
            kind:(v.kind?v.kind:'car')
          }
        };
      })
    };
  }

  function applyFilterAndRender(opts){
    opts = opts || {}; var fit = !!opts.fit;
    var cars=(window.__CITY_CACHE&&window.__CITY_CACHE.cars)||[];
    var sel=modelSelections.get(currentCity)||new Set();
    var filtered = sel.size ? cars.filter(function(v){ return sel.has(v.model); }) : [];
    var src = map.getSource('cars'); if(src) src.setData(toGeo(filtered));
    setCount(filtered.length);
    if(fit && filtered.length){
      var b=new maplibregl.LngLatBounds();
      for(var i=0;i<filtered.length;i++){ var v=filtered[i]; b.extend([Number(v.lng),Number(v.lat)]); }
      try{ map.fitBounds(b,{padding:60,maxZoom:15}); }catch(e){}
    }
  }

  function sameList(a,b){
    a=a||[]; b=b||[];
    return a.slice().sort().join('|')===b.slice().sort().join('|');
  }

  function buildModelPanelIfNeeded(grouped){
    var prev=modelOptions.get(currentCity);
    var need=!prev||!sameList(prev.car,grouped.car)||!sameList(prev.van,grouped.van)||!sameList(prev.scooter,grouped.scooter);
    if(!need) return;
    modelOptions.set(currentCity,grouped);
    modelSelections.set(currentCity,new Set([].concat(grouped.car||[],grouped.van||[],grouped.scooter||[])));
    var carsDiv=document.getElementById('models-cars'),vansDiv=document.getElementById('models-vans'),scootDiv=document.getElementById('models-scooters');
    function fill(el,arr){
      el.innerHTML='';
      (arr||[]).sort(function(a,b){return a.localeCompare(b,'pl');}).forEach(function(name){
        var id=currentCity+'-mdl-'+name.replace(/\W+/g,'-');
        var row=document.createElement('div'); row.className='row';
        row.innerHTML='<input type="checkbox" id="'+id+'" checked><label for="'+id+'">'+name+'</label>';
        var cb=row.querySelector('input');
        cb.addEventListener('change',function(){
          var set=modelSelections.get(currentCity);
          if(cb.checked)set.add(name); else set.delete(name);
          lastUIChange=Date.now(); applyFilterAndRender({fit:false});
        });
        el.appendChild(row);
      });
    }
    fill(carsDiv,grouped.car); fill(vansDiv,grouped.van); fill(scootDiv,grouped.scooter);
  }

  allBtn.addEventListener('click',function(){
    var opts=modelOptions.get(currentCity)||{car:[],van:[],scooter:[]};
    modelSelections.set(currentCity,new Set([].concat(opts.car||[],opts.van||[],opts.scooter||[])));
    Array.prototype.forEach.call(document.querySelectorAll('#models-cars input,#models-vans input,#models-scooters input'),function(cb){cb.checked=true;});
    lastUIChange=Date.now(); applyFilterAndRender({fit:false});
  });
  noneBtn.addEventListener('click',function(){
    modelSelections.set(currentCity,new Set());
    Array.prototype.forEach.call(document.querySelectorAll('#models-cars input,#models-vans input,#models-scooters input'),function(cb){cb.checked=false;});
    lastUIChange=Date.now(); applyFilterAndRender({fit:false});
  });

  citySel.addEventListener('change', function(){
    var nextCity = citySel.value;
    modelSelections.delete(nextCity);
    modelOptions.delete(nextCity);
    lastUIChange = 0;

    currentCity = nextCity;
    var cfg = centers[currentCity] || centers.krakow;
    var p = new URLSearchParams(location.search); p.set('city', currentCity);
    history.replaceState(null,'','?'+p.toString());

    clearTimeout(timer);
    var src=map.getSource('cars'); if(src) src.setData(emptyFC());
    setCount(0);

    map.easeTo({ center: cfg, zoom: cfg.z });
    loadAll(true, { fit:true });
    fitCityWidth();
  });

  refreshBtn.addEventListener('click',function(){
    setRefreshing(true);
    loadAll(false,{fit:false}).finally(function(){ setRefreshing(false); });
  });

  relCB.addEventListener('change',function(e){toggleLayer('relocation',e.target.checked);});
  nopCB.addEventListener('change',function(e){toggleLayer('nopark',e.target.checked);});
  ogCB .addEventListener('change',function(e){toggleLayer('ogarniam',e.target.checked);});
  function toggleLayer(k,on){
    var vis=on?'visible':'none';
    try{ map.setLayoutProperty(k+'-fill','visibility',vis); map.setLayoutProperty(k+'-outline','visibility',vis); }catch(e){}
  }

  function loadAll(first,opts){
    first = !!first; opts = opts || {}; var fit = !!opts.fit;
    fetch(API_CARS+'?city='+encodeURIComponent(currentCity))
      .then(function(r){return r.json();})
      .then(function(data){
        var cars = (Object.prototype.toString.call(data)==='[object Array]')?data:(data.cars||[]);
        var byKind={car:new Set(),van:new Set(),scooter:new Set()};
        for(var i=0;i<cars.length;i++){ var v=cars[i]; if(v&&v.model){ (byKind[v.kind||'car']||byKind.car).add(v.model); } }
        var grouped={car:Array.from(byKind.car),van:Array.from(byKind.van),scooter:Array.from(byKind.scooter)};
        if(Date.now()-lastUIChange>=1500){ buildModelPanelIfNeeded(grouped); }
        window.__CITY_CACHE.cars=cars; applyFilterAndRender({fit:fit});
      })
      .catch(function(e){ console.error(e); })
      .finally(function(){
        clearTimeout(timer); timer=setTimeout(function(){ loadAll(false,{fit:false}); },20000);
      });

    // zones (optional)
    fetch(API_AREAS+'?city='+encodeURIComponent(currentCity))
      .then(function(r){return r.json();})
      .then(function(areas){
        if(areas && areas.relocation){ var s=map.getSource('zones-relocation'); if(s) s.setData(areas.relocation); }
        if(areas && areas.nopark){     var s2=map.getSource('zones-nopark'); if(s2) s2.setData(areas.nopark); }
        if(areas && areas.ogarniam){   var s3=map.getSource('zones-ogarniam'); if(s3) s3.setData(areas.ogarniam); }
      })
      .catch(function(){});
  }

  window.addEventListener('load', fitCityWidth);
  window.addEventListener('resize', fitCityWidth);
})();
</script>
</body>
</html>

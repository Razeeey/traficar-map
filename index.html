<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>TrafiCar ‚Äî Live Cars</title>

<link rel="stylesheet" href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css"/>
<script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap">

<style>
  :root{
    --panel:#17171c; --panel2:#1f1f26; --text:#f5f6fa; --muted:#a7a7b4;
    --accent:#7b4bff; --accent2:#a07bff; --radius:12px; --shadow:0 10px 30px rgba(0,0,0,.35);
    --ink:#1a1b1e; --ink2:#6b7280; --card:#ffffff; --divider:#e5e7eb;
  }
  *{box-sizing:border-box}
  body{margin:0;background:#0c0c10;color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  #map{position:fixed;inset:0}

  /* top bar */
  .topbar{position:fixed;left:12px;right:12px;top:12px;z-index:10;display:flex;gap:10px;align-items:center;flex-wrap:wrap;background:rgba(23,23,28,.82);backdrop-filter:saturate(1.2) blur(8px);border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);padding:8px 10px;box-shadow:var(--shadow)}
  .brand{font-weight:800;background:linear-gradient(135deg,var(--accent),var(--accent2));padding:8px 12px;border-radius:10px}
  select,button{background:var(--panel2);color:var(--text);border:1px solid rgba(255,255,255,.08);padding:9px 12px;border-radius:10px;font-weight:600;cursor:pointer}
  select:hover,button:hover{border-color:rgba(255,255,255,.18)}
  .spacer{flex:1}
  .count{background:var(--panel2);border:1px solid rgba(255,255,255,.08);padding:6px 10px;border-radius:999px}

  /* filter panel */
  .panel{position:fixed;right:12px;top:64px;z-index:11;background:rgba(23,23,28,.92);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:12px;width:240px;box-shadow:var(--shadow)}
  .panel h4{margin:8px 0 6px;font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.04em}
  .row{display:flex;align-items:center;gap:10px;margin:6px 0;font-size:14px}
  .panel input[type="checkbox"]{width:18px;height:18px;cursor:pointer;accent-color:#7b4bff}
  .panel .small{display:flex;gap:12px;margin:4px 0 2px}
  .panel .small a{font-size:12px;color:#bfc0ca;text-decoration:underline;cursor:pointer}

  /* popup ‚Äì white card */
  .maplibregl-popup{max-width:360px !important}
  .maplibregl-popup-content{
    padding:12px;border-radius:14px;background:var(--card);color:var(--ink);
    box-shadow:0 18px 50px rgba(0,0,0,.45);border:1px solid #eceff3;
  }
  .maplibregl-popup-close-button{color:#444}
  .maplibregl-popup-anchor-top .maplibregl-popup-tip{border-bottom-color:var(--card)}
  .maplibregl-popup-anchor-bottom .maplibregl-popup-tip{border-top-color:var(--card)}
  .maplibregl-popup-anchor-left .maplibregl-popup-tip{border-right-color:var(--card)}
  .maplibregl-popup-anchor-right .maplibregl-popup-tip{border-left-color:var(--card)}

  .badge{background:#7b4bff;color:#fff;padding:4px 10px;border-radius:10px;font-weight:800;display:inline-block;min-width:52px;text-align:center}
  .muted{color:var(--ink2)}
  .infocard{min-width:300px;max-width:340px}
  .carimg{width:100%;height:auto;max-height:150px;object-fit:contain;border-radius:10px;background:transparent;margin-bottom:8px;display:block}
  .title{font-weight:800;font-size:16px;color:var(--ink)}
  .divider{height:1px;background:var(--divider);margin:6px 0 8px}

  /* refresh spinner */
  .spinner{display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,.35);border-top-color:#fff;border-radius:50%;animation:spin .9s linear infinite;vertical-align:-2px;margin-left:8px}
  @keyframes spin{to{transform:rotate(360deg)}}
  button[disabled]{opacity:.6;cursor:not-allowed}
</style>
</head>
<body>
<div id="map"></div>

<div class="topbar">
  <div class="brand">üöó TrafiCar</div>
  <label><span class="muted" style="font-size:.85rem;margin-right:6px">City</span>
    <select id="city">
      <option value="krakow">Krak√≥w</option>
      <option value="warszawa">Warszawa</option>
      <option value="wroclaw">Wroc≈Çaw</option>
      <option value="poznan">Pozna≈Ñ</option>
      <option value="trojmiasto">Tr√≥jmiasto</option>
      <option value="slask">≈ölƒÖsk</option>
      <option value="lublin">Lublin</option>
      <option value="lodz">≈Å√≥d≈∫</option>
      <option value="szczecin">Szczecin</option>
      <option value="rzeszow">Rzesz√≥w</option>
    </select>
  </label>
  <button id="refresh">Refresh <span id="spin" class="spinner" style="display:none"></span></button>
  <div class="spacer"></div>
  <div id="count" class="count">0 cars</div>
</div>

<!-- Right filter panel -->
<div class="panel">
  <h4>Osobowe</h4>
  <div id="models-cars"></div>
  <h4>Dostawcze</h4>
  <div id="models-vans"></div>
  <h4>Mikromobilno≈õƒá</h4>
  <div id="models-scooters"></div>
  <div class="small"><a id="all">Zaznacz wszystko</a><a id="none">Wyczy≈õƒá</a></div>
  <hr style="border:none;border-top:1px solid rgba(255,255,255,.08);margin:10px 0">
  <h4>Strefy</h4>
  <div class="row"><input type="checkbox" id="toggle-rel" checked><label for="toggle-rel">Relokacja</label></div>
  <div class="row"><input type="checkbox" id="toggle-nop" checked><label for="toggle-nop">Zakaz parkowania</label></div>
  <div class="row"><input type="checkbox" id="toggle-og" checked><label for="toggle-og">Ogarniam</label></div>
</div>

<script>
(function(){
  const MAPTILER_KEY = 'om295piVB9WpF6hwX1iC'; // ‚Üê put your key IN QUOTES

  const API_CARS  = '/.netlify/functions/traficar-auto';
  const API_AREAS = '/.netlify/functions/traficar-areas';

  /* ---------- helpers/state ---------- */
  const centers = {
    krakow:{lng:19.9383,lat:50.0614,z:13}, warszawa:{lng:21.0122,lat:52.2297,z:12},
    wroclaw:{lng:17.0385,lat:51.1079,z:13}, poznan:{lng:16.9252,lat:52.4064,z:13},
    trojmiasto:{lng:18.6383,lat:54.3722,z:11}, slask:{lng:19.0238,lat:50.2649,z:11},
    lublin:{lng:22.5684,lat:51.2465,z:13}, lodz:{lng:19.4550,lat:51.7592,z:12},
    szczecin:{lng:14.5528,lat:53.4285,z:12}, rzeszow:{lng:21.9990,lat:50.0413,z:13}
  };
  const params = new URLSearchParams(location.search);
  const initialCity = centers[params.get('city')] ? params.get('city') : 'krakow';

  const citySel = document.getElementById('city');
  const refreshBtn = document.getElementById('refresh');
  const spinEl = document.getElementById('spin');
  const countEl = document.getElementById('count');
  const allBtn = document.getElementById('all');
  const noneBtn= document.getElementById('none');
  const relCB = document.getElementById('toggle-rel');
  const nopCB = document.getElementById('toggle-nop');
  const ogCB  = document.getElementById('toggle-og');

  const setRefreshing = (on)=>{ refreshBtn.disabled = !!on; spinEl.style.display = on?'inline-block':'none'; };

  citySel.value = initialCity;
  let currentCity = citySel.value;

  // selections: city -> Set(model). We'll reset on city change.
  const modelSelections = new Map();
  const modelOptions    = new Map();
  let lastUIChange = 0; const noteUI = ()=>{ lastUIChange = Date.now(); };

  function slug(s){ return String(s||'').toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9\-]/g,''); }
  const CUSTOM_FILE_BY_MODEL = {
    'renault-arkana':  'renault-arkana-traficar',
    'renault-clio-v':  'renault-clio-traficar',
    'dacia-sandero':   'dacia-sandero-traficar',
    'dacia-dokker':    'dacia-dokker-traficar',
    'renault-express': 'renault-express-traficar',
    'renault-master':  'renault-master-traficar',
    'navee-d1-pro':    'NAVEE-D1-PRO-traficar'
  };
  function modelImage(model){
    const s = slug(model);
    const base = CUSTOM_FILE_BY_MODEL[s] ? `/img/${CUSTOM_FILE_BY_MODEL[s]}` : `/img/${s}`;
    return { webp: `${base}.webp`, jpg: `${base}.jpg` };
  }

  /* ---------- draw icons (pin + cluster pies) ---------- */
  // purple pin with a tiny car pictogram
  function pinImageData(){
    const size = 64, r = 16, cvs = document.createElement('canvas');
    cvs.width = size; cvs.height = size; const g = cvs.getContext('2d'); const cx = size/2, cy = size/2;
    g.beginPath(); g.arc(cx, cy, r+3, 0, Math.PI*2); g.fillStyle = 'rgba(0,0,0,.45)'; g.fill();
    g.beginPath(); g.arc(cx, cy, r, 0, Math.PI*2); g.fillStyle = '#7b4bff'; g.fill();
    g.fillStyle = '#fff';                       // simple "car"
    g.fillRect(cx-10, cy-6, 20, 10);
    g.beginPath(); g.arc(cx-6, cy+6, 3, 0, Math.PI*2); g.arc(cx+6, cy+6, 3, 0, Math.PI*2); g.fill();
    return g.getImageData(0,0,size,size);
  }
  function pieImageData(c,v,s){
    const size=64*2,r=size/2,cvs=document.createElement('canvas');cvs.width=size;cvs.height=size;const g=cvs.getContext('2d');
    g.beginPath();g.arc(r,r,r-4,0,Math.PI*2);g.fillStyle='#3e3e45';g.fill();
    const T=Math.max(1,c+v+s);let a=-Math.PI/2;
    const slice=(n,col)=>{const ang=(n/T)*Math.PI*2;g.beginPath();g.moveTo(r,r);g.arc(r,r,r-8,a,a+ang,false);g.closePath();g.fillStyle=col;g.fill();a+=ang;};
    slice(c,'#7b4bff'); slice(v,'#1d4ed8'); slice(s,'#2dd4bf');
    g.beginPath();g.arc(r,r,r-28,0,Math.PI*2);g.fillStyle='#121218';g.fill();
    g.beginPath();g.arc(r,r,r-3,0,Math.PI*2);g.strokeStyle='#111';g.lineWidth=4;g.stroke();
    return g.getImageData(0,0,size,size);
  }

  /* ---------- map ---------- */
  const map = new maplibregl.Map({
    container:'map',
    style: `https://api.maptiler.com/maps/dataviz-dark/style.json?key=${MAPTILER_KEY}`,
    center: centers[initialCity],
    zoom: centers[initialCity].z,
    attributionControl:true
  });
  map.addControl(new maplibregl.NavigationControl({ showCompass:false }), 'bottom-right');

  map.on('load', async () => {
    try { map.addImage('car-pin', pinImageData(), { pixelRatio:2 }); } catch {}

    map.addSource('cars', {
      type:'geojson', data: emptyFC(),
      cluster:true, clusterRadius:64, clusterMaxZoom:14,
      clusterProperties:{
        car:["+",["case",["==",["get","kind"],"car"],1,0]],
        van:["+",["case",["==",["get","kind"],"van"],1,0]],
        scooter:["+",["case",["==",["get","kind"],"scooter"],1,0]]
      }
    });

    // cluster pie icons
    const PIE_CACHE = new Set();
    map.on('styleimagemissing', (e)=>{
      const m=/^pie_(\d+)_(\d+)_(\d+)$/.exec(e.id); if(!m||PIE_CACHE.has(e.id))return;
      try{ map.addImage(e.id, pieImageData(+m[1],+m[2],+m[3]), { pixelRatio:2 }); PIE_CACHE.add(e.id); map.triggerRepaint(); }catch{}
    });
    map.on('idle', ()=>{
      const feats=map.queryRenderedFeatures({layers:['clusters-pie']});
      for(const f of feats){
        const id=`pie_${f.properties.car|0}_${f.properties.van|0}_${f.properties.scooter|0}`;
        if(!map.hasImage(id)){ try{ map.addImage(id, pieImageData(f.properties.car|0,f.properties.van|0,f.properties.scooter|0), { pixelRatio:2 }); }catch{} }
      }
    });

    map.addLayer({ id:'clusters-bg', type:'circle', source:'cars', filter:['has','point_count'],
      paint:{'circle-color':'#3e3e45','circle-stroke-color':'#111','circle-stroke-width':2,
             'circle-radius':['interpolate',['linear'],['get','point_count'],2,14,50,18,200,24,500,28]}});
    map.addLayer({ id:'clusters-pie', type:'symbol', source:'cars', filter:['has','point_count'],
      layout:{'icon-image':['concat','pie_',['to-string',['coalesce',['get','car'],0]],'_',['to-string',['coalesce',['get','van'],0]],'_',['to-string',['coalesce',['get','scooter'],0]]],
              'icon-size':['interpolate',['linear'],['get','point_count'],2,.85,50,1.0,200,1.25,500,1.5],
              'icon-allow-overlap': true,
              'text-field':['get','point_count_abbreviated'],'text-size':12,
              'text-font':['Open Sans Semibold','Arial Unicode MS Bold'],'text-offset':[0,0],'text-allow-overlap':true},
      paint:{'text-color':'#ffffff','text-halo-color':'#111','text-halo-width':1.2}});

    // purple pin for each single vehicle
    map.addLayer({
      id: 'cars-pin',
      type: 'symbol',
      source: 'cars',
      filter: ['!',['has','point_count']],
      layout: { 'icon-image':'car-pin', 'icon-size':1, 'icon-allow-overlap':true }
    });

    // overlays
    map.addSource('zones-relocation',{type:'geojson',data:emptyFC()});
    map.addSource('zones-nopark',{type:'geojson',data:emptyFC()});
    map.addSource('zones-ogarniam',{type:'geojson',data:emptyFC()});
    map.addLayer({id:'relocation-fill',type:'fill',source:'zones-relocation',paint:{'fill-color':'#ffd500','fill-opacity':0.22}});
    map.addLayer({id:'relocation-outline',type:'line',source:'zones-relocation',paint:{'line-color':'#ffd500','line-width':2}});
    map.addLayer({id:'nopark-fill',type:'fill',source:'zones-nopark',paint:{'fill-color':'#ff4d4d','fill-opacity':0.28}});
    map.addLayer({id:'nopark-outline',type:'line',source:'zones-nopark',paint:{'line-color':'#ff4d4d','line-width':1.5,'line-dasharray':[2,2]}});
    map.addLayer({id:'ogarniam-fill',type:'fill',source:'zones-ogarniam',paint:{'fill-color':'#a56cff','fill-opacity':0.16}});
    map.addLayer({id:'ogarniam-outline',type:'line',source:'zones-ogarniam',paint:{'line-color':'#a56cff','line-width':2}});

    // click popup on pin
    map.on('click','cars-pin',(e)=>{
      const v=e.features[0].properties; const [lng,lat]=e.features[0].geometry.coordinates;
      const badge=v.number?v.number:(v.id?String(v.id).slice(-4):''); const plate=v.plate||'';
      const pct=(v.pct!=null)?`${v.pct}%`:'‚Äî'; const range=(v.rangeKm!=null)?` (${v.rangeKm} km)`:'';
      const addr=v.address||''; const apple=`https://maps.apple.com/?ll=${lat},${lng}&q=${encodeURIComponent(v.model||'Car')}`;
      const img=modelImage(v.model);
      const titleEsc = String(v.model||'Vehicle').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');

      const html=`
        <div class="infocard">
          <img class="carimg"
               loading="lazy"
               src="${img.webp}"
               onerror="if(this.dataset.step!=='jpg'){this.dataset.step='jpg';this.src='${img.jpg}';}else{this.onerror=null;this.style.display='none';}"
               alt="${titleEsc}">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">
            <span class="badge">${badge}</span>
            <div class="title">${titleEsc}</div>
          </div>
          <div class="muted" style="margin:-2px 0 8px">${plate||'&nbsp;'}</div>
          <div class="muted" style="margin:6px 0">‚õΩ <b>${pct}${range}</b></div>
          <div class="muted" style="margin:6px 0">üìç ${addr}</div>
          <div class="divider"></div>
          <div style="margin:8px 0"><a href="${apple}" target="_blank" rel="noopener">Open in Apple Maps</a></div>
        </div>`;
      new maplibregl.Popup({closeButton:true,offset:12}).setLngLat([lng,lat]).setHTML(html).addTo(map);
    });

    // hover tooltip
    let hoverPopup = null;
    map.on('mouseenter','cars-pin', (e)=>{
      map.getCanvas().style.cursor = 'pointer';
      const p = e.features[0].properties;
      const txt = `${p.model || 'Vehicle'}${p.number ? ' ‚Ä¢ ' + p.number : ''}`;
      hoverPopup = new maplibregl.Popup({ closeButton:false, closeOnClick:false, offset:10 })
        .setLngLat(e.features[0].geometry.coordinates)
        .setText(txt)
        .addTo(map);
    });
    map.on('mouseleave','cars-pin', ()=>{
      map.getCanvas().style.cursor = '';
      if (hoverPopup) { hoverPopup.remove(); hoverPopup = null; }
    });

    await loadAll(true,{fit:true});
  });

  /* ---------- data/filter plumbing ---------- */
  let timer=null; window.__CITY_CACHE={cars:[]};
  const setCount=n=>{countEl.textContent=`${n} ${n===1?'car':'cars'}`};
  const emptyFC=()=>({type:'FeatureCollection',features:[]});
  const toGeo=data=>({type:'FeatureCollection',features:data.map(v=>({type:'Feature',geometry:{type:'Point',coordinates:[Number(v.lng),Number(v.lat)]},properties:{id:v.id??null,model:v.model??'Vehicle',plate:v.plate??'',number:v.number??'',pct:(typeof v.pct==='number')?v.pct:null,rangeKm:(typeof v.rangeKm==='number')?v.rangeKm:null,address:v.address||'',kind:v.kind||'car'}}))});

  function applyFilterAndRender({fit=false}={}){
    const cars=window.__CITY_CACHE.cars||[]; const sel=modelSelections.get(currentCity)||new Set();
    const filtered=sel.size?cars.filter(v=>sel.has(v.model)):[];
    map.getSource('cars')?.setData(toGeo(filtered)); setCount(filtered.length);
    if(fit&&filtered.length){const b=new maplibregl.LngLatBounds(); filtered.forEach(v=>b.extend([Number(v.lng),Number(v.lat)])); try{map.fitBounds(b,{padding:60,maxZoom:15})}catch{}}
  }

  function sameList(a=[],b=[]){return a.slice().sort().join('|')===b.slice().sort().join('|')}
  function buildModelPanelIfNeeded(grouped){
    const prev=modelOptions.get(currentCity); const need=!prev||!sameList(prev.car,grouped.car)||!sameList(prev.van,grouped.van)||!sameList(prev.scooter,grouped.scooter);
    if(!need) return;
    modelOptions.set(currentCity,grouped);
    // init selection to "all checked"
    modelSelections.set(currentCity,new Set([...(grouped.car||[]),...(grouped.van||[]),...(grouped.scooter||[])]));

    const carsDiv=document.getElementById('models-cars'),vansDiv=document.getElementById('models-vans'),scootDiv=document.getElementById('models-scooters');
    function fill(el,arr){
      el.innerHTML='';
      (arr||[]).sort((a,b)=>a.localeCompare(b,'pl')).forEach(name=>{
        const id=`${currentCity}-mdl-${name.replace(/\W+/g,'-')}`;
        const row=document.createElement('div'); row.className='row';
        row.innerHTML=`<input type="checkbox" id="${id}" checked><label for="${id}">${name}</label>`;
        const cb=row.querySelector('input');
        cb.addEventListener('change',()=>{
          const set=modelSelections.get(currentCity);
          if(cb.checked)set.add(name); else set.delete(name);
          noteUI(); applyFilterAndRender({fit:false});
        });
        el.appendChild(row);
      });
    }
    fill(carsDiv,grouped.car); fill(vansDiv,grouped.van); fill(scootDiv,grouped.scooter);
  }

  // Select all / none
  allBtn.addEventListener('click',()=>{
    const opts=modelOptions.get(currentCity)||{car:[],van:[],scooter:[]};
    modelSelections.set(currentCity,new Set([...(opts.car||[]),...(opts.van||[]),...(opts.scooter||[])]));
    document.querySelectorAll('#models-cars input,#models-vans input,#models-scooters input').forEach(cb=>cb.checked=true);
    noteUI(); applyFilterAndRender({fit:false});
  });
  noneBtn.addEventListener('click',()=>{
    modelSelections.set(currentCity,new Set());
    document.querySelectorAll('#models-cars input,#models-vans input,#models-scooters input').forEach(cb=>cb.checked=false);
    noteUI(); applyFilterAndRender({fit:false});
  });

  // City change ‚Äî ALWAYS reset filters for the city we switch to
  citySel.addEventListener('change', ()=>{
    const nextCity = citySel.value;

    modelSelections.delete(nextCity);  // forget any previous custom set for the target city
    modelOptions.delete(nextCity);     // force re-build of the checkbox list
    lastUIChange = 0;

    currentCity = nextCity;

    const cfg = centers[currentCity] || centers.krakow;
    const p = new URLSearchParams(location.search); p.set('city', currentCity);
    history.replaceState(null,'',`?${p.toString()}`);

    clearTimeout(timer);
    map.getSource('cars')?.setData(emptyFC());
    setCount(0);

    map.easeTo({ center: cfg, zoom: cfg.z });
    loadAll(true, { fit:true });  // rebuilds filters to "all checked"
  });

  // Refresh with spinner
  refreshBtn.addEventListener('click',()=>{
    setRefreshing(true);
    loadAll(false,{fit:false}).finally(()=> setRefreshing(false));
  });

  // overlays toggles
  relCB.addEventListener('change',e=>toggleLayer('relocation',e.target.checked));
  nopCB.addEventListener('change',e=>toggleLayer('nopark',e.target.checked));
  ogCB .addEventListener('change',e=>toggleLayer('ogarniam',e.target.checked));
  function toggleLayer(k,on){const v=on?'visible':'none'; map.setLayoutProperty(`${k}-fill`,'visibility',v); map.setLayoutProperty(`${k}-outline`,'visibility',v);}

  async function loadAll(first=false,{fit=false}={}){
    try{
      const qs=new URLSearchParams({city:currentCity});
      const cached=localStorage.getItem(`traficar_zones_${currentCity}`);
      if(cached&&!first){ try{const z=JSON.parse(cached); if(Array.isArray(z.zones)&&(Date.now()-z.ts<10*60*1000)) qs.set('zones',z.zones.join(',')); }catch{} }
      const res=await fetch(`${API_CARS}?${qs.toString()}`); const data=await res.json();
      let cars,zones; if(Array.isArray(data)){cars=data;} else{cars=data.cars||[]; zones=data.zones||[];}
      if(Array.isArray(zones)&&zones.length){ localStorage.setItem(`traficar_zones_${currentCity}`,JSON.stringify({zones,ts:Date.now()})); }
      const byKind={car:new Set(),van:new Set(),scooter:new Set()};
      for(const v of cars) if(v&&v.model) (byKind[v.kind||'car']||byKind.car).add(v.model);
      const grouped={car:[...byKind.car],van:[...byKind.van],scooter:[...byKind.scooter]};
      const tooSoon=Date.now()-lastUIChange<1500; if(!tooSoon) buildModelPanelIfNeeded(grouped);
      window.__CITY_CACHE.cars=cars; applyFilterAndRender({fit});
    }catch(e){console.error(e);}
    try{
      const res=await fetch(`${API_AREAS}?city=${encodeURIComponent(currentCity)}`);
      const areas=await res.json();

      let any=false;
      if(areas?.relocation){ map.getSource('zones-relocation')?.setData(areas.relocation); any=true; }
      if(areas?.nopark)    { map.getSource('zones-nopark')?.setData(areas.nopark);       any=true; }
      if(areas?.ogarniam)  { map.getSource('zones-ogarniam')?.setData(areas.ogarniam);   any=true; }

      // static fallback if function doesn't provide polygons
      if(!any){
        const tryOne = async (suffix, srcId) => {
          const r = await fetch(`/zones/${currentCity}-${suffix}.geojson`);
          if (r.ok) { const gj = await r.json(); map.getSource(srcId)?.setData(gj); }
        };
        await Promise.all([
          tryOne('relokacja','zones-relocation'),
          tryOne('nopark','zones-nopark'),
          tryOne('ogarniam','zones-ogarniam')
        ]);
      }
    }catch(e){ /* ignore zones errors */ }
    clearTimeout(timer); timer=setTimeout(()=>loadAll(false,{fit:false}),20000);
  }
})();
</script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TrafiCar Live Map</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap">

  <style>
    :root{
      --bg:#0f0f12; --panel:#17171c; --panel2:#1f1f26; --text:#f4f4f6; --muted:#a7a7b4;
      --accent:#7b4bff; --accent2:#a07bff; --ok:#3ddc84; --shadow:0 10px 30px rgba(0,0,0,.35); --radius:20px;
    }
    *{box-sizing:border-box}
    body{margin:0; background:linear-gradient(180deg,#0b0b0e,#141419); color:var(--text); font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    #map{position:fixed; inset:0}

    .topbar{
      position:fixed; inset:16px 16px auto 16px; z-index:1000; display:flex; gap:12px; align-items:center; flex-wrap:wrap;
      background:rgba(23,23,28,.75); backdrop-filter:saturate(1.2) blur(8px);
      border:1px solid rgba(255,255,255,.06); border-radius:var(--radius); padding:10px 12px; box-shadow:var(--shadow);
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:800; padding:8px 12px; background:linear-gradient(135deg,var(--accent),var(--accent2)); border-radius:14px; color:white}
    .pill, select, button, .toggle{background:var(--panel2); color:var(--text); border:1px solid rgba(255,255,255,.06); padding:9px 12px; border-radius:14px; font-weight:600; cursor:pointer}
    .pill:hover, select:hover, button:hover, .toggle:hover{ border-color:rgba(255,255,255,.14)}
    .city{min-width:150px}
    .spacer{flex:1}

    .panel{
      position:fixed; right:16px; top:86px; z-index:999; width:360px; max-width:calc(100% - 32px);
      background:rgba(23,23,28,.92); border:1px solid rgba(255,255,255,.06); border-radius:var(--radius);
      padding:14px; box-shadow:var(--shadow); display:none;
    }
    .panel h3{margin:6px 0 10px}
    .row{display:flex; gap:10px; margin-bottom:10px}
    .row label{font-size:.9rem; color:var(--muted)}
    .row input[type="range"]{width:100%}

    .footer{
      position:fixed; left:16px; bottom:16px; z-index:999; display:flex; gap:10px; align-items:center;
      padding:8px 10px; background:rgba(23,23,28,.8); border:1px solid rgba(255,255,255,.06); border-radius:12px;
      box-shadow:var(--shadow); font-size:.9rem; color:var(--muted)
    }
    .badge{background:var(--panel2); padding:4px 8px; border-radius:999px; font-weight:700}
    .dot{width:10px; height:10px; border-radius:50%}
    .dot.ok{background:var(--ok)} .dot.low{background:#ffb020} .dot.crit{background:#ff6b6b}
    .spinner{display:inline-block; width:14px; height:14px; border:2px solid #ffffff30; border-top-color:#fff; border-radius:50%; animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .toggle{display:flex; align-items:center; gap:8px; user-select:none}
    .toggle input{accent-color:#7b4bff}
  </style>
</head>
<body>
  <div id="map" role="application" aria-label="Traficar cars map"></div>

  <div class="topbar">
    <div class="brand">üöó TrafiCar Radar</div>

    <select id="city" class="city" title="Select city">
      <option value="krakow" selected>Krak√≥w</option>
      <option value="warszawa">Warszawa</option>
      <option value="wroclaw">Wroc≈Çaw</option>
      <option value="poznan">Pozna≈Ñ</option>
      <option value="trojmiasto">Tr√≥jmiasto</option>
      <option value="slask">≈ölƒÖsk</option>
      <option value="lublin">Lublin</option>
      <option value="lodz">≈Å√≥d≈∫</option>
      <option value="szczecin">Szczecin</option>
      <option value="rzeszow">Rzesz√≥w</option>
    </select>

    <label class="toggle" title="Show only available cars">
      <input id="onlyAvail" type="checkbox" checked>
      Available only
    </label>

    <button id="filterBtn" class="pill">Filter ‚ñæ</button>
    <button id="refreshBtn" class="pill">Refresh</button>
    <div class="spacer"></div>
    <button id="locateBtn" class="pill">üìç My location</button>
    <button id="themeBtn" class="pill">üåì</button>
  </div>

  <div id="filterPanel" class="panel" aria-hidden="true">
    <h3>Filters</h3>
    <div class="row">
      <label style="flex:1">
        Model
        <select id="modelSelect" style="width:100%">
          <option value="">All models</option>
        </select>
      </label>
    </div>
    <div class="row">
      <label style="flex:1">
        Min fuel / charge: <span id="fuelVal">0%</span>
        <input id="fuelRange" type="range" min="0" max="100" step="5" value="0">
      </label>
    </div>
    <div class="row">
      <label style="flex:1">
        Radius from map center (<span id="radiusVal">0</span> m; 0 = off)
        <input id="radiusRange" type="range" min="0" max="5000" step="100" value="0">
      </label>
    </div>
    <div class="row" style="justify-content:flex-end;">
      <button id="applyFilters" class="pill" style="background:linear-gradient(135deg,var(--accent),var(--accent2));color:white">Apply</button>
    </div>
  </div>

  <div class="footer">
    <span id="status"><span class="spinner"></span> Loading‚Ä¶</span>
    <span class="badge" id="count">0 cars</span>
    <div style="display:flex;gap:10px;align-items:center">
      <span class="dot ok" title="‚â• 50%"></span><span>OK</span>
      <span class="dot low" title="20‚Äì49%"></span><span>Low</span>
      <span class="dot crit" title="< 20%"></span><span>Critical</span>
    </div>
    <span>‚Ä¢ Data: fioletowe.live API</span>
  </div>

  <script>
  (() => {
    // Helpers
    const $ = id => document.getElementById(id);
    const statusEl = () => $('status') || { textContent: '' };
    function safe(fn){ try { return fn(); } catch(e){ console.error(e); statusEl().textContent = 'JS error: ' + e.message; } }
    function color(p){ if(p>=50) return '#3ddc84'; if(p>=20) return '#ffb020'; return '#ff6b6b'; }
    const toRad = x=>x*Math.PI/180, R=6371000;
    const dist = (a,b)=>{ const dLat=toRad(b[0]-a[0]), dLon=toRad(b[1]-a[1]); const A=Math.sin(dLat/2)**2+Math.cos(toRad(a[0]))*Math.cos(toRad(b[0]))*Math.sin(dLon/2)**2; return R*2*Math.atan2(Math.sqrt(A),Math.sqrt(1-A)); };
    const km = m => (m/1000).toFixed(1);

    const API = '/.netlify/functions/traficar-auto';
    const centers = {
      krakow:[50.0614,19.9383], warszawa:[52.2297,21.0122], wroclaw:[51.1079,17.0385],
      poznan:[52.4064,16.9252], trojmiasto:[54.3722,18.6383], slask:[50.2649,19.0238],
      lublin:[51.2465,22.5684], lodz:[51.7592,19.4550], szczecin:[53.4285,14.5528], rzeszow:[50.0413,21.9990]
    };

    // Map init
    let map, tiles, cluster, circle=null, myLoc=null;
    let lastCity='krakow', onlyAvailable=true, timer=null, isLoading=false;
    let lastGoodData=[];  // cache to keep UI stable
    let currentData=[];

    safe(() => {
      map = L.map('map', { zoomControl:false }).setView(centers.krakow, 13);
      L.control.zoom({position:'bottomright'}).addTo(map);
      tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap'}).addTo(map);
      cluster = L.markerClusterGroup({ showCoverageOnHover:false, disableClusteringAtZoom:17 });
      map.addLayer(cluster);
    });

    // UI refs
    const city=$('city'), filterBtn=$('filterBtn'), panel=$('filterPanel'), refreshBtn=$('refreshBtn'), locateBtn=$('locateBtn'), themeBtn=$('themeBtn');
    const modelSel=$('modelSelect'), fuel=$('fuelRange'), fuelVal=$('fuelVal'), radius=$('radiusRange'), radiusVal=$('radiusVal'), apply=$('applyFilters');
    const onlyAvail=$('onlyAvail');
    const count=$('count');
    if (fuelVal && fuel) fuelVal.textContent = fuel.value + '%';
    if (radiusVal && radius) radiusVal.textContent = radius.value;

    // Events
    if (filterBtn && panel) filterBtn.onclick = () => { panel.style.display = (panel.style.display==='block'?'none':'block'); panel.setAttribute('aria-hidden', panel.style.display!=='block'); };
    if (apply) apply.onclick = () => { if (panel) panel.style.display='none'; render(currentData, true); };
    if (fuel && fuelVal) fuel.oninput = () => fuelVal.textContent = fuel.value + '%';
    if (radius && radiusVal) radius.oninput = () => { radiusVal.textContent = radius.value; drawRadius(); render(currentData, true); };
    if (city) city.onchange = () => { lastCity = city.value; safe(() => map.setView(centers[lastCity]||centers.krakow,13)); load(lastCity); };
    if (onlyAvail) onlyAvail.onchange = () => { onlyAvailable = !!onlyAvail.checked; load(lastCity); };
    if (refreshBtn) refreshBtn.onclick = () => load(lastCity);
    if (locateBtn) locateBtn.onclick = () => {
      if (!navigator.geolocation) return alert('Geolocation not supported');
      navigator.geolocation.getCurrentPosition(p => {
        myLoc = [p.coords.latitude, p.coords.longitude];
        safe(() => map.setView(myLoc, 14));
        drawRadius(); render(currentData, true);
      }, () => alert('Could not get your location'));
    };
    if (themeBtn) themeBtn.onclick = () => {
      safe(() => {
        if (document.body.dataset.theme==='light'){ document.body.dataset.theme=''; tiles.setUrl('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'); }
        else { document.body.dataset.theme='light'; tiles.setUrl('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png'); }
      });
    };

    function drawRadius(){
      if (!radius) return;
      const r = +radius.value;
      if (circle){ map.removeLayer(circle); circle=null; }
      if (r>0){ circle = L.circle(map.getCenter(), { radius:r, color:'#7b4bff', weight:1, fillOpacity:0.05 }); circle.addTo(map); }
    }

    // Build model dropdown from the *cached* lastGoodData so it never goes blank
    function buildModelOptions(data){
      if (!modelSel) return;
      const names = Array.from(new Set((data||[]).map(v => v.model).filter(Boolean))).sort((a,b)=>a.localeCompare(b,'pl'));
      const cur = modelSel.value;
      modelSel.innerHTML = '<option value="">All models</option>' + names.map(n=>`<option>${n}</option>`).join('');
      if (names.includes(cur)) modelSel.value = cur;
    }

    function qtyText(v){
      if (v.pct==null || !v.maxFuel) return null;
      const val = Math.round(v.maxFuel * (v.pct/100));
      const unit = v.isElectric ? 'kWh' : 'L';
      return `${val}/${v.maxFuel}${unit}`;
    }

    const addrCache = new Map();
    async function reverseGeocode(lat,lng){
      const key = lat.toFixed(5)+','+lng.toFixed(5);
      if (addrCache.has(key)) return addrCache.get(key);
      try{
        const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`;
        const r = await fetch(url, { headers: { 'Accept':'application/json' }});
        const j = await r.json();
        const s = j.address ? [
          j.address.city || j.address.town || j.address.village || '',
          j.address.road ? `ul. ${j.address.road}` : ''
        ].filter(Boolean).join(', ') : (j.display_name || '');
        addrCache.set(key, s);
        return s;
      }catch{ return ''; }
    }

    function render(data, fromFilter=false){
      currentData = Array.isArray(data) ? data : [];
      if (!fromFilter) buildModelOptions(lastGoodData.length ? lastGoodData : currentData);

      const center = myLoc || (centers[lastCity] || centers.krakow);
      const r = radius ? +radius.value : 0;
      const min = fuel ? +fuel.value : 0;
      const m = modelSel ? modelSel.value.trim() : '';

      // Apply client-side filters (model, min fuel, radius)
      const filtered = currentData.filter(v => {
        if (!v || typeof v.lat !== 'number' || typeof v.lng !== 'number') return false;
        if (m && v.model !== m) return false;
        if (min && (v.pct==null || v.pct < min)) return false;
        if (r>0){ const d = dist(center, [v.lat, v.lng]); if (d > r) return false; }
        return true;
      });

      safe(() => cluster.clearLayers());
      let n=0;

      for (const v of filtered){
        const pctLabel = (v.pct==null ? '‚Äî' : (Math.round(v.pct)+'%'));
        const qty = qtyText(v);
        const range = (v.rangeKm!=null ? ` (${v.rangeKm} km)` : '');
        const fuelKind = v.isElectric ? 'Bateria' : 'Paliwo';
        const icon = L.divIcon({ className:'mk', html:`<div style="width:22px;height:22px;border-radius:50%;background:${color(v.pct??100)};border:2px solid #111;box-shadow:0 0 0 2px rgba(0,0,0,.25)"></div>` });
        const marker = L.marker([v.lat, v.lng], { icon });

        const badgeText = (v.number!=null && String(v.number).trim()!=='')
          ? String(v.number)
          : (v.id!=null ? String(v.id).slice(-4) : '');
        const badge = badgeText ? `<span style="background:#7b4bff;color:#fff;padding:4px 8px;border-radius:10px;font-weight:700;display:inline-block;min-width:46px;text-align:center">${badgeText}</span>` : '';

        const registration = v.plate || '';
        const qtyOrPct = qty ? `${qty}${range}` : `${pctLabel}${range}`;
        const apple = `https://maps.apple.com/?ll=${v.lat},${v.lng}&q=${encodeURIComponent(v.model || 'Car')}`;

        const card = document.createElement('div');
        card.style.minWidth = '280px';
        card.innerHTML = `
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
            ${badge}
            <div style="font-weight:800">${v.model || 'Vehicle'}</div>
          </div>
          <div style="color:#a7a7b4;margin-top:-2px;margin-bottom:8px">${registration || ' '}</div>
          <div style="color:#a7a7b4;margin:6px 0">‚õΩ ${fuelKind}: <b>${qtyOrPct}</b></div>
          <div style="color:#a7a7b4;margin:6px 0">üìç <span class="addr">${v.address || '≈Åadowanie adresu‚Ä¶'}</span></div>
          <div style="margin:8px 0"><a href="${apple}" target="_blank" rel="noopener">Otw√≥rz w Apple Maps</a></div>
        `;

        marker.bindPopup(card);
        marker.on('popupopen', async () => {
          const el = card.querySelector('.addr');
          if (el && (!v.address || v.address.length < 6)) {
            const addr = await reverseGeocode(v.lat, v.lng);
            el.textContent = addr || '';
          }
        });

        safe(() => cluster.addLayer(marker));
        n++;
      }

      if (count) count.textContent = `${n} cars`;
      statusEl().textContent = `Updated ${new Date().toLocaleTimeString()}`;
    }

    async function load(cityName='krakow'){
      if (isLoading) return;           // prevent overlapping fetches
      isLoading = true;
      if (timer) { clearTimeout(timer); timer = null; }

      statusEl().textContent = 'Loading‚Ä¶';
      lastCity = cityName;

      try{
        const params = new URLSearchParams();
        params.set('city', cityName);
        if (!onlyAvailable) params.set('all','1');  // show everything if toggle off
        params.set('strict','1');                   // conservative availability in backend
        const res = await fetch(`${API}?${params.toString()}`);
        const data = await res.json();

        // If we got some data, accept and cache it; if not, keep previous data
        if (Array.isArray(data) && data.length){
          lastGoodData = data;
          render(data);
        } else {
          statusEl().textContent = 'No data (using previous good data)';
          if (lastGoodData.length) render(lastGoodData);
          else render([]); // first load and empty -> show 0
        }
      }catch(e){
        console.error(e);
        statusEl().textContent='Network error (using previous data)';
        if (lastGoodData.length) render(lastGoodData);
      } finally {
        isLoading = false;
        // schedule next refresh
        timer = setTimeout(() => load(lastCity), 20000);
      }
    }

    // Kick off
    load('krakow');
  })();
  </script>
</body>
</html>
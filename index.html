<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>TrafiCar ‚Äî Live Cars</title>

<link rel="stylesheet" href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css"/>
<script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap">

<style>
  :root{ --panel:#17171c; --panel2:#1f1f26; --text:#f5f6fa; --muted:#a7a7b4; --accent:#7b4bff; --accent2:#a07bff; --radius:12px; --shadow:0 10px 30px rgba(0,0,0,.35); }
  *{box-sizing:border-box}
  body{margin:0;background:#0c0c10;color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  #map{position:fixed;inset:0}

  .topbar{
    position:fixed; left:12px; right:12px; top:12px; z-index:10;
    display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    background:rgba(23,23,28,.82); backdrop-filter:saturate(1.2) blur(8px);
    border:1px solid rgba(255,255,255,.06); border-radius:var(--radius);
    padding:8px 10px; box-shadow:var(--shadow)
  }
  .brand{font-weight:800;background:linear-gradient(135deg,var(--accent),var(--accent2));padding:8px 12px;border-radius:10px}
  select,button{background:var(--panel2);color:var(--text);border:1px solid rgba(255,255,255,.08);padding:9px 12px;border-radius:10px;font-weight:600;cursor:pointer}
  select:hover,button:hover{border-color:rgba(255,255,255,.18)}
  .spacer{flex:1}
  .count{background:var(--panel2);border:1px solid rgba(255,255,255,.08);padding:6px 10px;border-radius:999px}

  /* right filter panel */
  .panel{
    position:fixed; right:12px; top:64px; z-index:11;
    background:rgba(23,23,28,.92); backdrop-filter: blur(8px);
    border:1px solid rgba(255,255,255,.08); border-radius:12px;
    padding:10px 12px; width:220px; box-shadow:var(--shadow);
  }
  .panel h4{margin:6px 0 8px; font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:.04em}
  .panel label{display:flex; align-items:center; gap:8px; margin:6px 0; font-size:14px}
  .panel input[type="checkbox"]{width:16px; height:16px; cursor:pointer}
  .chip{display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; background:#22222a; border:1px solid rgba(255,255,255,.06); color:#bfc0ca}

  .badge{background:#7b4bff;color:#fff;padding:4px 8px;border-radius:10px;font-weight:800;display:inline-block;min-width:46px;text-align:center}
  .muted{color:var(--muted)}
  .infocard{min-width:280px;max-width:320px}
</style>
</head>
<body>
<div id="map"></div>

<div class="topbar">
  <div class="brand">üöó TrafiCar</div>
  <label><span class="muted" style="font-size:.85rem;margin-right:6px">City</span>
    <select id="city">
      <option value="krakow">Krak√≥w</option>
      <option value="warszawa">Warszawa</option>
      <option value="wroclaw">Wroc≈Çaw</option>
      <option value="poznan">Pozna≈Ñ</option>
      <option value="trojmiasto">Tr√≥jmiasto</option>
      <option value="slask">≈ölƒÖsk</option>
      <option value="lublin">Lublin</option>
      <option value="lodz">≈Å√≥d≈∫</option>
      <option value="szczecin">Szczecin</option>
      <option value="rzeszow">Rzesz√≥w</option>
    </select>
  </label>
  <button id="refresh">Refresh</button>
  <div class="spacer"></div>
  <div id="count" class="count">0 cars</div>
</div>

<!-- Right filter panel -->
<div class="panel" id="filters">
  <h4>Osobowe</h4>
  <div id="models-cars"></div>
  <h4>Dostawcze</h4>
  <div id="models-vans"></div>
  <h4>Mikromobilno≈õƒá</h4>
  <div id="models-scooters"></div>
  <hr style="border:none;border-top:1px solid rgba(255,255,255,.08);margin:8px 0">
  <h4>Strefy</h4>
  <label><input type="checkbox" id="toggle-rel" checked> Relokacja <span class="chip">≈º√≥≈Çta</span></label>
  <label><input type="checkbox" id="toggle-nop" checked> Zakaz parkowania <span class="chip">czerwona</span></label>
  <label><input type="checkbox" id="toggle-og" checked> Ogarniam <span class="chip">fiolet</span></label>
</div>

<script>
(function(){
  // Put your MapTiler key here (IN QUOTES):
  const MAPTILER_KEY = 'om295piVB9WpF6hwX1iC';

  const API_CARS  = '/.netlify/functions/traficar-auto';
  const API_AREAS = '/.netlify/functions/traficar-areas';

  const centers = {
    krakow:{lng:19.9383,lat:50.0614,z:13}, warszawa:{lng:21.0122,lat:52.2297,z:12},
    wroclaw:{lng:17.0385,lat:51.1079,z:13}, poznan:{lng:16.9252,lat:52.4064,z:13},
    trojmiasto:{lng:18.6383,lat:54.3722,z:11}, slask:{lng:19.0238,lat:50.2649,z:11},
    lublin:{lng:22.5684,lat:51.2465,z:13}, lodz:{lng:19.4550,lat:51.7592,z:12},
    szczecin:{lng:14.5528,lat:53.4285,z:12}, rzeszow:{lng:21.9990,lat:50.0413,z:13}
  };

  const params = new URLSearchParams(location.search);
  const initialCity = centers[params.get('city')] ? params.get('city') : 'krakow';

  const citySel = document.getElementById('city');
  const refreshBtn = document.getElementById('refresh');
  const countEl = document.getElementById('count');
  const relCB = document.getElementById('toggle-rel');
  const nopCB = document.getElementById('toggle-nop');
  const ogCB  = document.getElementById('toggle-og');

  citySel.value = initialCity;
  let currentCity = citySel.value;

  // Per-city selection set: Set(modelName).  NULL means ‚Äúnot initialised yet‚Äù.
  const modelSelections = new Map(); // city -> Set or null
  // Cache of available options per city
  const modelOptions = new Map();    // city -> {car:[],van:[],scooter:[]}

  // Map
  const map = new maplibregl.Map({
    container:'map',
    style: `https://api.maptiler.com/maps/dataviz-dark/style.json?key=${MAPTILER_KEY}`,
    center: centers[initialCity],
    zoom: centers[initialCity].z,
    attributionControl:true
  });
  map.addControl(new maplibregl.NavigationControl({ showCompass:false }), 'bottom-right');

  map.on('load', async () => {
    // clustered cars with category counters
    map.addSource('cars', {
      type:'geojson',
      data: emptyFC(),
      cluster:true, clusterRadius: 64, clusterMaxZoom: 14,
      clusterProperties: {
        car:     ["+", ["case", ["==", ["get","kind"], "car"], 1, 0]],
        van:     ["+", ["case", ["==", ["get","kind"], "van"], 1, 0]],
        scooter: ["+", ["case", ["==", ["get","kind"], "scooter"], 1, 0]]
      }
    });

    // cluster pies + count
    map.addLayer({
      id:'clusters-pie', type:'symbol', source:'cars', filter:['has','point_count'],
      layout:{
        'icon-image': ['concat','pie_', ['to-string',['coalesce',['get','car'],0]], '_', ['to-string',['coalesce',['get','van'],0]], '_', ['to-string',['coalesce',['get','scooter'],0]]],
        'icon-size': 1,
        'icon-allow-overlap': true,
        'text-field': ['get','point_count_abbreviated'],
        'text-size': 12,
        'text-font': ['Open Sans Semibold','Arial Unicode MS Bold'],
        'text-offset': [0, 0],
        'text-allow-overlap': true
      },
      paint:{ 'text-color':'#ffffff', 'text-halo-color':'#111', 'text-halo-width':1.2 }
    });

    // unclustered points
    map.addLayer({
      id:'unclustered', type:'circle', source:'cars', filter:['!',['has','point_count']],
      paint:{
        'circle-color':[
          'case',
            ['!', ['has','pct']], '#8e8e93',
            ['>=', ['get','pct'], 50], '#3ddc84',
            ['>=', ['get','pct'], 20], '#ffb020',
            '#ff6b6b'
        ],
        'circle-stroke-color':'#111',
        'circle-stroke-width':2,
        'circle-radius':8
      }
    });

    // overlays
    map.addSource('zones-relocation', { type:'geojson', data: emptyFC() });
    map.addSource('zones-nopark',     { type:'geojson', data: emptyFC() });
    map.addSource('zones-ogarniam',   { type:'geojson', data: emptyFC() });
    map.addLayer({ id:'relocation-fill', type:'fill', source:'zones-relocation', paint:{ 'fill-color':'#ffd500', 'fill-opacity':0.22 }});
    map.addLayer({ id:'relocation-outline', type:'line', source:'zones-relocation', paint:{ 'line-color':'#ffd500', 'line-width':2 }});
    map.addLayer({ id:'nopark-fill', type:'fill', source:'zones-nopark', paint:{ 'fill-color':'#ff4d4d', 'fill-opacity':0.28 }});
    map.addLayer({ id:'nopark-outline', type:'line', source:'zones-nopark', paint:{ 'line-color':'#ff4d4d', 'line-width':1.5, 'line-dasharray':[2,2] }});
    map.addLayer({ id:'ogarniam-fill', type:'fill', source:'zones-ogarniam', paint:{ 'fill-color':'#a56cff', 'fill-opacity':0.16 }});
    map.addLayer({ id:'ogarniam-outline', type:'line', source:'zones-ogarniam', paint:{ 'line-color':'#a56cff', 'line-width':2 }});

    // popups
    map.on('click','unclustered', (e)=>{
      const v = e.features[0].properties;
      const [lng,lat] = e.features[0].geometry.coordinates;
      const badge = v.number ? v.number : (v.id ? String(v.id).slice(-4) : '');
      const plate = v.plate || '';
      const pct = (v.pct!=null) ? `${v.pct}%` : '‚Äî';
      const range = (v.rangeKm!=null) ? ` (${v.rangeKm} km)` : '';
      const addr = v.address || '';
      const apple = `https://maps.apple.com/?ll=${lat},${lng}&q=${encodeURIComponent(v.model || 'Car')}`;
      const html = `
        <div class="infocard">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">
            <span class="badge">${badge}</span>
            <div style="font-weight:800">${v.model || 'Vehicle'}</div>
          </div>
          <div class="muted" style="margin:-2px 0 8px">${plate || '&nbsp;'}</div>
          <div class="muted" style="margin:6px 0">‚õΩ <b>${pct}${range}</b></div>
          <div class="muted" style="margin:6px 0">üìç ${addr}</div>
          <div style="margin:8px 0"><a href="${apple}" target="_blank" rel="noopener">Open in Apple Maps</a></div>
        </div>
      `;
      new maplibregl.Popup({ closeButton:true, offset:12 }).setLngLat([lng,lat]).setHTML(html).addTo(map);
    });

    // PIE ICONS ‚Äî two ways (so they always render):
    // a) auto-generate on demand
    const PIE_CACHE = new Set();
    map.on('styleimagemissing', (e) => {
      const m = /^pie_(\d+)_(\d+)_(\d+)$/.exec(e.id);
      if (!m || PIE_CACHE.has(e.id)) return;
      const img = makePie(+m[1], +m[2], +m[3]);
      try { map.addImage(e.id, img, { pixelRatio:2 }); PIE_CACHE.add(e.id); map.triggerRepaint(); } catch {}
    });
    // b) and also sweep visible clusters every idle frame (fallback)
    map.on('idle', () => {
      const feats = map.queryRenderedFeatures({ layers:['clusters-pie'] });
      for (const f of feats) {
        const id = `pie_${f.properties.car|0}_${f.properties.van|0}_${f.properties.scooter|0}`;
        if (map.hasImage(id)) continue;
        const img = makePie(f.properties.car|0, f.properties.van|0, f.properties.scooter|0);
        try { map.addImage(id, img, { pixelRatio:2 }); } catch {}
      }
    });

    // initial load
    await loadAll(true, { fit:true });
  });

  // draw a pie icon (purple cars, dark-blue vans, turquoise scooters)
  function makePie(c,v,s){
    const size = 64; const r = size/2;
    const cvs = document.createElement('canvas'); cvs.width=size; cvs.height=size;
    const g = cvs.getContext('2d');
    g.beginPath(); g.arc(r,r,r-2,0,Math.PI*2); g.fillStyle='#3e3e45'; g.fill();
    const total = Math.max(1, c+v+s);
    let start = -Math.PI/2;
    const slice = (val,color)=>{
      const ang = (val/total)*Math.PI*2;
      g.beginPath(); g.moveTo(r,r); g.arc(r,r,r-4,start,start+ang,false); g.closePath();
      g.fillStyle=color; g.fill(); start+=ang;
    };
    slice(c,'#7b4bff'); // cars
    slice(v,'#1d4ed8'); // vans
    slice(s,'#2dd4bf'); // scooters
    g.beginPath(); g.arc(r,r,r-18,0,Math.PI*2); g.fillStyle='#121218'; g.fill();
    g.beginPath(); g.arc(r,r,r-1,0,Math.PI*2); g.strokeStyle='#111'; g.lineWidth=2; g.stroke();
    return cvs;
  }

  // ---------- state/helpers ----------
  let timer = null;
  function emptyFC(){ return { type:'FeatureCollection', features: [] }; }
  function setCount(n){ countEl.textContent = `${n} ${n===1?'car':'cars'}`; }

  function toGeo(data){
    return {
      type:'FeatureCollection',
      features: data.map(v => ({
        type:'Feature',
        geometry:{ type:'Point', coordinates:[Number(v.lng), Number(v.lat)] },
        properties:{
          id: v.id ?? null, model: v.model ?? 'Vehicle',
          plate: v.plate ?? '', number: v.number ?? '',
          pct: (typeof v.pct === 'number') ? v.pct : null,
          rangeKm: (typeof v.rangeKm === 'number') ? v.rangeKm : null,
          address: v.address || '',
          kind: v.kind || 'car'
        }
      }))
    };
  }

  // Apply current filter and paint. If selection === empty Set ‚Üí show NONE.
  function applyFilterAndRender({fit=false}={}){
    const cars = window.__CITY_CACHE?.cars || [];
    const sel = modelSelections.get(currentCity); // Set or null
    let filtered;
    if (sel === null) {
      // should never happen now; treat as ALL
      filtered = cars;
    } else if (sel.size === 0) {
      filtered = []; // user unchecked everything ‚Üí show none
    } else {
      filtered = cars.filter(v => sel.has(v.model));
    }
    map.getSource('cars')?.setData(toGeo(filtered));
    setCount(filtered.length);
    if (fit && filtered.length){
      const b = new maplibregl.LngLatBounds();
      filtered.forEach(v => b.extend([Number(v.lng), Number(v.lat)]));
      try { map.fitBounds(b, { padding: 60, maxZoom: 15 }); } catch {}
    }
  }

  // Build/update the checklist without destroying the user‚Äôs choice.
  function buildModelPanel(grouped){
    modelOptions.set(currentCity, grouped);

    // all model names available now
    const all = [...(grouped.car||[]), ...(grouped.van||[]), ...(grouped.scooter||[])];

    // initialise selection for this city ONCE to ‚Äúall checked‚Äù
    if (!modelSelections.has(currentCity)) {
      modelSelections.set(currentCity, new Set(all));
    } else {
      // keep existing selections; add any new models as checked; remove missing models
      const set = modelSelections.get(currentCity);
      for (const name of all) if (!set.has(name)) set.add(name);    // new model ‚Üí checked by default
      for (const name of Array.from(set)) if (!all.includes(name)) set.delete(name);
    }

    const carsDiv = document.getElementById('models-cars');
    const vansDiv = document.getElementById('models-vans');
    const scootDiv= document.getElementById('models-scooters');

    function fill(el, arr){
      el.innerHTML = '';
      arr.sort((a,b)=>a.localeCompare(b,'pl')).forEach(name=>{
        const id = `${currentCity}-mdl-${name.replace(/\W+/g,'-')}`;
        const wrap = document.createElement('label');
        wrap.innerHTML = `<input type="checkbox" id="${id}"> ${name}`;
        const cb = wrap.querySelector('input');
        cb.checked = modelSelections.get(currentCity).has(name);
        cb.addEventListener('change', ()=>{
          const set = modelSelections.get(currentCity);
          if (cb.checked) set.add(name); else set.delete(name);
          applyFilterAndRender({fit:false}); // don‚Äôt recenter on filter change
        });
        el.appendChild(wrap);
      });
    }
    fill(carsDiv, grouped.car||[]);
    fill(vansDiv, grouped.van||[]);
    fill(scootDiv, grouped.scooter||[]);
  }

  // UI events
  citySel.addEventListener('change', ()=>{
    currentCity = citySel.value;
    const cfg = centers[currentCity] || centers.krakow;
    const p = new URLSearchParams(location.search); p.set('city', currentCity); history.replaceState(null,'',`?${p.toString()}`);
    clearTimeout(timer);
    map.getSource('cars')?.setData(emptyFC());
    setCount(0);
    map.easeTo({ center: cfg, zoom: cfg.z }); // only on city change
    loadAll(true, { fit:true });
  });

  refreshBtn.addEventListener('click', ()=> loadAll(false, { fit:false }));

  // overlay toggles
  document.getElementById('toggle-rel').addEventListener('change', (e)=>{
    map.setLayoutProperty('relocation-fill','visibility', e.target.checked ? 'visible' : 'none');
    map.setLayoutProperty('relocation-outline','visibility', e.target.checked ? 'visible' : 'none');
  });
  document.getElementById('toggle-nop').addEventListener('change', (e)=>{
    map.setLayoutProperty('nopark-fill','visibility', e.target.checked ? 'visible' : 'none');
    map.setLayoutProperty('nopark-outline','visibility', e.target.checked ? 'visible' : 'none');
  });
  document.getElementById('toggle-og').addEventListener('change', (e)=>{
    map.setLayoutProperty('ogarniam-fill','visibility', e.target.checked ? 'visible' : 'none');
    map.setLayoutProperty('ogarniam-outline','visibility', e.target.checked ? 'visible' : 'none');
  });

  // simple city cache
  window.__CITY_CACHE = { cars: [] };

  async function loadAll(first=false, {fit=false}={}){
    // cars
    try{
      const qs = new URLSearchParams({ city: currentCity });
      const cachedZones = localStorage.getItem(`traficar_zones_${currentCity}`);
      if (cachedZones && !first){
        try{ const z = JSON.parse(cachedZones); if (Array.isArray(z.zones) && (Date.now()-z.ts<10*60*1000)) qs.set('zones', z.zones.join(',')); }catch{}
      }
      const res = await fetch(`${API_CARS}?${qs.toString()}`);
      const data = await res.json();

      let cars, zones;
      if (Array.isArray(data)) { cars = data; }
      else { cars = data.cars || []; zones = data.zones || []; }

      if (Array.isArray(zones) && zones.length){
        localStorage.setItem(`traficar_zones_${currentCity}`, JSON.stringify({ zones, ts: Date.now() }));
      }

      // group models for the checklist
      const byKind = { car:new Set(), van:new Set(), scooter:new Set() };
      for (const v of cars) if (v && v.model) (byKind[v.kind||'car']||byKind.car).add(v.model);
      const grouped = { car:[...byKind.car], van:[...byKind.van], scooter:[...byKind.scooter] };

      buildModelPanel(grouped);          // preserves previous selections
      window.__CITY_CACHE.cars = cars;   // store
      applyFilterAndRender({fit});       // render with current selection
    }catch(e){ console.error(e); }

    // areas
    try{
      const res = await fetch(`${API_AREAS}?city=${encodeURIComponent(currentCity)}`);
      const areas = await res.json();
      if (areas?.relocation) map.getSource('zones-relocation')?.setData(areas.relocation);
      if (areas?.nopark)     map.getSource('zones-nopark')?.setData(areas.nopark);
      if (areas?.ogarniam)   map.getSource('zones-ogarniam')?.setData(areas.ogarniam);
    }catch(e){ /* fine if not available */ }

    clearTimeout(timer);
    timer = setTimeout(()=> loadAll(false, {fit:false}), 20000);
  }

  // helpers
  function emptyFC(){ return { type:'FeatureCollection', features: [] }; }

})();
</script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>TrafiCar ‚Äî Live Cars</title>

  <!-- MapLibre GL (free & smooth) -->
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css"/>
  <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap">
  <style>
    :root{
      --panel:#17171c; --panel2:#1f1f26; --text:#f5f6fa; --muted:#a7a7b4;
      --accent:#7b4bff; --accent2:#a07bff; --radius:14px; --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b0b0e,#141419);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    #map{position:fixed;inset:0}
    .topbar{
      position:fixed;inset:12px 12px auto 12px;z-index:10;display:flex;gap:10px;align-items:center;flex-wrap:wrap;
      background:rgba(23,23,28,.82);backdrop-filter:saturate(1.2) blur(8px);border:1px solid rgba(255,255,255,.06);
      border-radius:var(--radius);padding:8px 10px;box-shadow:var(--shadow)
    }
    .brand{font-weight:800;background:linear-gradient(135deg,var(--accent),var(--accent2));padding:8px 12px;border-radius:12px}
    select,button{background:var(--panel2);color:var(--text);border:1px solid rgba(255,255,255,.08);padding:9px 12px;border-radius:12px;font-weight:600;cursor:pointer}
    select:hover,button:hover{border-color:rgba(255,255,255,.18)}
    .spacer{flex:1}
    .count{background:var(--panel2);border:1px solid rgba(255,255,255,.08);padding:6px 10px;border-radius:999px}
    .badge{background:#7b4bff;color:#fff;padding:4px 8px;border-radius:10px;font-weight:800;display:inline-block;min-width:46px;text-align:center}
    .muted{color:var(--muted)}
    .infocard{min-width:280px;max-width:320px}
  </style>
</head>
<body>
  <div id="map" aria-label="Traficar map"></div>

  <div class="topbar">
    <div class="brand">üöó TrafiCar</div>
    <label>
      <span class="muted" style="font-size:.85rem;margin-right:6px">City</span>
      <select id="city">
        <option value="krakow">Krak√≥w</option>
        <option value="warszawa">Warszawa</option>
        <option value="wroclaw">Wroc≈Çaw</option>
        <option value="poznan">Pozna≈Ñ</option>
        <option value="trojmiasto">Tr√≥jmiasto</option>
        <option value="slask">≈ölƒÖsk</option>
        <option value="lublin">Lublin</option>
        <option value="lodz">≈Å√≥d≈∫</option>
        <option value="szczecin">Szczecin</option>
        <option value="rzeszow">Rzesz√≥w</option>
      </select>
    </label>

    <label>
      <span class="muted" style="font-size:.85rem;margin:0 6px 0 12px">Model</span>
      <select id="model"><option value="">All</option></select>
    </label>

    <button id="refresh">Refresh</button>
    <div class="spacer"></div>
    <div id="count" class="count">0 cars</div>
  </div>

  <script>
  (function(){
    // üîë MapTiler free key
    const MAPTILER_KEY = 'om295piVB9WpF6hwX1iC'; // <-- paste your key here

    // API for cars (your Netlify function already city-filters & returns only available)
    const API = '/.netlify/functions/traficar-auto';

    // City centers + default zooms
    const centers = {
      krakow:{lng:19.9383,lat:50.0614,z:13}, warszawa:{lng:21.0122,lat:52.2297,z:12},
      wroclaw:{lng:17.0385,lat:51.1079,z:13}, poznan:{lng:16.9252,lat:52.4064,z:13},
      trojmiasto:{lng:18.6383,lat:54.3722,z:11}, slask:{lng:19.0238,lat:50.2649,z:11},
      lublin:{lng:22.5684,lat:51.2465,z:13}, lodz:{lng:19.4550,lat:51.7592,z:12},
      szczecin:{lng:14.5528,lat:53.4285,z:12}, rzeszow:{lng:21.9990,lat:50.0413,z:13}
    };

    // Read ?city= from URL
    const params = new URLSearchParams(location.search);
    const initialCity = centers[params.get('city')] ? params.get('city') : 'krakow';

    const citySel = document.getElementById('city');
    const modelSel = document.getElementById('model');
    const refreshBtn = document.getElementById('refresh');
    const countEl = document.getElementById('count');

    citySel.value = initialCity;

    let map, sourceReady=false, lastGood=[], isLoading=false, timer=null;

    // Init map
    map = new maplibregl.Map({
      container: 'map',
      style: `https://api.maptiler.com/maps/streets/style.json?key=${MAPTILER_KEY}`,
      center: centers[initialCity],
      zoom: centers[initialCity].z,
      attributionControl: true
    });
    map.addControl(new maplibregl.NavigationControl({ showCompass:false }), 'bottom-right');

    map.on('load', () => {
      // GeoJSON source with clustering
      map.addSource('cars', {
        type: 'geojson',
        data: { type: 'FeatureCollection', features: [] },
        cluster: true, clusterRadius: 60, clusterMaxZoom: 14
      });
      // Cluster circles
      map.addLayer({
        id:'clusters', type:'circle', source:'cars', filter:['has','point_count'],
        paint:{
          'circle-color':'#3e3e45',
          'circle-stroke-color':'#111',
          'circle-stroke-width':2,
          'circle-radius':['step',['get','point_count'],16, 20, 20, 50, 26, 100, 32]
        }
      });
      // Cluster counts
      map.addLayer({
        id:'cluster-count', type:'symbol', source:'cars', filter:['has','point_count'],
        layout:{ 'text-field':['get','point_count_abbreviated'],'text-font':['Open Sans Semibold','Arial Unicode MS Bold'],'text-size':12 },
        paint:{ 'text-color':'#fff' }
      });
      // Unclustered points: color by fuel %
      map.addLayer({
        id:'unclustered', type:'circle', source:'cars', filter:['!',['has','point_count']],
        paint:{
          'circle-color':[
            'case',
              ['!', ['has','pct']], '#8e8e93',
              ['>=', ['get','pct'], 50], '#3ddc84',
              ['>=', ['get','pct'], 20], '#ffb020',
              '#ff6b6b'
          ],
          'circle-stroke-color':'#111',
          'circle-stroke-width':2,
          'circle-radius':8
        }
      });

      // Interaction
      map.on('click','clusters', async (e)=>{
        const features = map.queryRenderedFeatures(e.point, { layers:['clusters'] });
        const clusterId = features[0].properties.cluster_id;
        map.getSource('cars').getClusterExpansionZoom(clusterId, (err, zoom)=>{
          if (err) return;
          map.easeTo({ center: features[0].geometry.coordinates, zoom });
        });
      });

      map.on('click','unclustered', (e)=>{
        const v = e.features[0].properties;
        const coords = e.features[0].geometry.coordinates.slice();
        const badge = v.number ? v.number : (v.id ? String(v.id).slice(-4) : '');
        const plate = v.plate || '';
        const pct = (v.pct!=null) ? `${v.pct}%` : '‚Äî';
        const range = (v.rangeKm!=null) ? ` (${v.rangeKm} km)` : '';
        const addr = v.address || '';
        const apple = `https://maps.apple.com/?ll=${coords[1]},${coords[0]}&q=${encodeURIComponent(v.model || 'Car')}`;

        const html = `
          <div class="infocard">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">
              <span class="badge">${badge}</span>
              <div style="font-weight:800">${v.model || 'Vehicle'}</div>
            </div>
            <div class="muted" style="margin:-2px 0 8px">${plate || '&nbsp;'}</div>
            <div class="muted" style="margin:6px 0">‚õΩ <b>${pct}${range}</b></div>
            <div class="muted" style="margin:6px 0">üìç ${addr}</div>
            <div style="margin:8px 0"><a href="${apple}" target="_blank" rel="noopener">Open in Apple Maps</a></div>
          </div>
        `;
        new maplibregl.Popup({ closeButton:true, offset:12 }).setLngLat(coords).setHTML(html).addTo(map);
      });

      map.on('mouseenter','unclustered', ()=> map.getCanvas().style.cursor='pointer');
      map.on('mouseleave','unclustered', ()=> map.getCanvas().style.cursor='');

      sourceReady = true;
      load(); // first load
    });

    // UI events
    citySel.addEventListener('change', ()=>{
      const c = citySel.value;
      const center = centers[c] || centers.krakow;
      map.easeTo({ center, zoom:center.z });
      const p = new URLSearchParams(location.search); p.set('city', c); history.replaceState(null,'',`?${p.toString()}`);
      load();
    });
    modelSel.addEventListener('change', ()=> render(lastGood));
    document.getElementById('refresh').addEventListener('click', ()=> load());

    // Helpers
    function setCount(n){ countEl.textContent = `${n} ${n===1?'car':'cars'}`; }
    function buildModels(data){
      const names = Array.from(new Set(data.map(v=>v.model).filter(Boolean))).sort((a,b)=>a.localeCompare(b,'pl'));
      const cur = modelSel.value;
      modelSel.innerHTML = '<option value="">All</option>' + names.map(n=>`<option>${n}</option>`).join('');
      if (names.includes(cur)) modelSel.value = cur;
    }
    function toGeo(data){
      return {
        type:'FeatureCollection',
        features: data.map(v => ({
          type:'Feature',
          geometry:{ type:'Point', coordinates:[Number(v.lng), Number(v.lat)] },
          properties:{
            id: v.id ?? null,
            model: v.model ?? 'Vehicle',
            plate: v.plate ?? '',
            number: v.number ?? '',
            pct: (typeof v.pct === 'number') ? v.pct : null,
            rangeKm: (typeof v.rangeKm === 'number') ? v.rangeKm : null,
            address: v.address || ''
          }
        }))
      };
    }

    function render(data){
      // cache & model list
      if (Array.isArray(data) && data.length) lastGood = data.slice();
      buildModels(lastGood);

      // model filter client-side
      const mod = modelSel.value.trim();
      const filtered = (lastGood.length ? lastGood : data).filter(v => {
        if (!v) return false;
        const lat = Number(v.lat), lng = Number(v.lng);
        if (!Number.isFinite(lat) || !Number.isFinite(lng)) return false;
        if (mod && v.model !== mod) return false;
        return true;
      });

      // push to map
      if (sourceReady){
        const src = map.getSource('cars');
        if (src) src.setData(toGeo(filtered));
      }
      setCount(filtered.length);

      // fit to data on each load (for the chosen city)
      if (filtered.length){
        const b = new maplibregl.LngLatBounds();
        filtered.forEach(v => b.extend([Number(v.lng), Number(v.lat)]));
        try { map.fitBounds(b, { padding: 60, maxZoom: 15 }); } catch {}
      }
    }

    async function load(){
      if (!sourceReady || isLoading) return;
      isLoading = true;
      if (timer) { clearTimeout(timer); timer = null; }

      const city = citySel.value;
      try{
        const res = await fetch(`${API}?city=${encodeURIComponent(city)}`);
        const data = await res.json();
        if (Array.isArray(data) && data.length) render(data);
        else if (lastGood.length) render(lastGood);
        else render([]);
      } catch (e) {
        console.error(e);
        if (lastGood.length) render(lastGood);
      } finally {
        isLoading = false;
        timer = setTimeout(load, 20000);
      }
    }
  })();
  </script>
</body>
</html>
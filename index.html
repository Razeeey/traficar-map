<script>
(function(){
  const API = '/.netlify/functions/traficar-auto';

  const centers = {
    krakow:[50.0614,19.9383], warszawa:[52.2297,21.0122], wroclaw:[51.1079,17.0385], poznan:[52.4064,16.9252],
    trojmiasto:[54.3722,18.6383], slask:[50.2649,19.0238], lublin:[51.2465,22.5684], lodz:[51.7592,19.4550],
    szczecin:[53.4285,14.5528], rzeszow:[50.0413,21.9990]
  };

  // Map + cluster
  const map = L.map('map', { zoomControl:false }).setView(centers.krakow, 13);
  L.control.zoom({position:'bottomright'}).addTo(map);
  const tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap'}).addTo(map);
  const cluster = L.markerClusterGroup({ showCoverageOnHover:false, spiderfyOnMaxZoom:true, disableClusteringAtZoom:17 });
  map.addLayer(cluster);

  // UI refs
  const $ = id => document.getElementById(id);
  const city=$('city'), filterBtn=$('filterBtn'), panel=$('filterPanel'), refreshBtn=$('refreshBtn'), locateBtn=$('locateBtn'), themeBtn=$('themeBtn');
  const fuel=$('fuelRange'), fuelVal=$('fuelVal'), radius=$('radiusRange'), radiusVal=$('radiusVal'), modelSel=$('modelSelect'), evOnly=createEvToggle(), apply=$('applyFilters');
  const status=$('status'), count=$('count'); let circle=null, timer=null, myLoc=null, lastData=[];

  function createEvToggle(){ const c=document.getElementById('evOnly'); return c || (function(){ const i=document.createElement('input'); i.type='checkbox'; i.id='evOnly'; return i; })(); }

  // Helpers
  function drawRadius(){ const r=+radius.value; if(circle){ map.removeLayer(circle); circle=null; } if(r>0){ circle=L.circle(map.getCenter(),{radius:r,color:'#7b4bff',weight:1,fillOpacity:0.05}); circle.addTo(map);} }
  function color(p){ if(p>=50) return '#3ddc84'; if(p>=20) return '#ffb020'; return '#ff6b6b'; }
  const toRad = x=>x*Math.PI/180, R=6371000;
  function dist(a,b){ const dLat=toRad(b[0]-a[0]), dLon=toRad(b[1]-a[1]); const A=Math.sin(dLat/2)**2+Math.cos(toRad(a[0]))*Math.cos(toRad(b[0]))*Math.sin(dLon/2)**2; return R*2*Math.atan2(Math.sqrt(A),Math.sqrt(1-A)); }
  const km = m => (m/1000).toFixed(1);
  const addressCache = new Map();
  async function reverseGeocode(lat,lng){
    const key = lat.toFixed(5)+','+lng.toFixed(5);
    if (addressCache.has(key)) return addressCache.get(key);
    try{
      const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`;
      const res = await fetch(url, { headers: { 'Accept':'application/json' }});
      const j = await res.json();
      const addr = j.display_name || '';
      addressCache.set(key, addr);
      return addr;
    }catch{ return ''; }
  }

  function buildModelOptions(data){
    const names = Array.from(new Set(data.map(v => v.model).filter(Boolean))).sort((a,b)=>a.localeCompare(b,'pl'));
    const cur = modelSel.value;
    modelSel.innerHTML = '<option value="">All models</option>' + names.map(n=>`<option>${n}</option>`).join('');
    if (names.includes(cur)) modelSel.value = cur;
  }

  function litersOrKwh(v){
    if (v.pct==null || !v.maxFuel) return null;
    const val = Math.round(v.maxFuel * (v.pct/100));
    const cap = v.maxFuel;
    const unit = v.isElectric ? 'kWh' : 'L';
    return `${val}/${cap}${unit}`;
  }

  // UI events
  filterBtn.onclick=()=>{ panel.style.display=(panel.style.display==='block'?'none':'block'); panel.setAttribute('aria-hidden', panel.style.display!=='block'); };
  apply.onclick=()=>{ panel.style.display='none'; render(lastData,true); };
  fuel.oninput=()=> fuelVal.textContent=fuel.value+'%';
  radius.oninput=()=>{ radiusVal.textContent=radius.value; drawRadius(); render(lastData,true); };
  city.onchange=()=>{ map.setView(centers[city.value]||centers.krakow,13); render(lastData,true); };
  refreshBtn.onclick=()=> load();
  locateBtn.onclick=()=>{ if(!navigator.geolocation) return alert('Geolocation not supported');
    navigator.geolocation.getCurrentPosition(p=>{ myLoc=[p.coords.latitude,p.coords.longitude]; map.setView(myLoc,14); drawRadius(); render(lastData,true); },()=> alert('Could not get your location')); };
  themeBtn.onclick=()=>{ if(document.body.dataset.theme==='light'){ document.body.dataset.theme=''; tiles.setUrl('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'); } else { document.body.dataset.theme='light'; tiles.setUrl('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png'); } };

  function render(data, fromFilter=false){
    lastData = Array.isArray(data) ? data : [];
    if (!fromFilter) buildModelOptions(lastData);

    const center = myLoc || centers[city.value] || centers.krakow;
    const r = +radius.value, min = +fuel.value, m = modelSel.value.trim(), wantEV = evOnly.checked;

    cluster.clearLayers(); let n=0;
    for(const v of lastData){
      if (!v || typeof v.lat !== 'number' || typeof v.lng !== 'number') continue;
      if (m && v.model !== m) continue;
      if (wantEV && !v.isElectric) continue;
      if (min && (v.pct==null || v.pct < min)) continue;
      if (r>0){ const d = dist(center, [v.lat, v.lng]); if (d > r) continue; }

      const dMeters = dist(center, [v.lat, v.lng]);
      const pctLabel = (v.pct==null ? '‚Äî' : (Math.round(v.pct)+'%'));
      const qty = litersOrKwh(v); // e.g., "14/50L" or "36/60kWh"
      const range = (v.rangeKm!=null ? ` (${v.rangeKm} km)` : '');
      const fuelKind = v.isElectric ? 'Bateria' : 'Paliwo';
      const icon = L.divIcon({ className:'mk', html:`<div style="width:22px;height:22px;border-radius:50%;background:${color(v.pct??100)};border:2px solid #111;box-shadow:0 0 0 2px rgba(0,0,0,.25)"></div>` });

      const marker = L.marker([v.lat, v.lng], { icon });
      const apple = `https://maps.apple.com/?ll=${v.lat},${v.lng}&q=${encodeURIComponent(v.model || 'Car')}`;

      // Base card (address will be filled asynchronously)
      const idBadge = v.id!=null ? `<div style="position:absolute;left:10px;top:10px;background:#7b4bff;color:#fff;font-weight:700;padding:4px 8px;border-radius:10px;">${v.id}</div>` : '';
      const imgTag = v.img ? `<img src="${v.img}" alt="${v.model||'Car'}" style="width:100%;height:140px;object-fit:cover;border-radius:12px">` : '';
      const plate = v.plate || '‚Äî';
      const qtyText = qty ? `${qty}${range}` : `${pctLabel}${range}`;

      const card = document.createElement('div');
      card.style.minWidth = '280px';
      card.innerHTML = `
        <div style="position:relative;margin-bottom:8px;border-radius:12px;overflow:hidden">${imgTag}${idBadge}</div>
        <div style="font-weight:800;margin-bottom:2px">${v.model || 'Vehicle'}</div>
        <div style="color:#a7a7b4;margin-bottom:8px">${plate}</div>
        <div style="display:flex;gap:8px;align-items:center;margin:6px 0">
          <div>üìç <span class="addr" style="color:#a7a7b4">≈Åadowanie adresu‚Ä¶</span></div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;margin:6px 0">
          <div>‚õΩ <span style="color:#a7a7b4">${fuelKind}: <b>${qtyText}</b></span></div>
        </div>
        <div style="margin:8px 0"><a href="${apple}" target="_blank" rel="noopener">Otw√≥rz w Apple Maps</a></div>
      `;

      marker.bindPopup(card);
      marker.on('popupopen', async ()=>{
        const addr = await reverseGeocode(v.lat, v.lng);
        const el = card.querySelector('.addr');
        if (el) el.textContent = addr || `Odleg≈Ço≈õƒá od centrum: ${km(dMeters)} km`;
      });

      cluster.addLayer(marker);
      n++;
    }

    count.textContent = `${n} cars`;
    status.textContent = `Updated ${new Date().toLocaleTimeString()}`;
  }

  async function load(){
    try{
      status.innerHTML = '<span class="spinner"></span> Loading‚Ä¶';
      const res = await fetch(API);
      if(!res.ok){ const t=await res.text().catch(()=> ''); status.textContent='Proxy error '+res.status+(t?(' ‚Äî '+t.slice(0,120)):''); return; }
      const data = await res.json();
      render(data);
      if (timer) clearTimeout(timer);
      timer = setTimeout(load, 20000);
    }catch(e){ console.error(e); status.textContent='Could not load data'; if(timer) clearTimeout(timer); }
  }

  // Wire up remaining UI bits after DOM exists
  (function initUI(){
    fuelVal.textContent = fuel.value + '%';
    radiusVal.textContent = radius.value;
  })();

  load();
})();
</script>
